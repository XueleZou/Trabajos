---
title: "TRATA"
author: "Xuele"
date: "2023-03-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


#Datos
```{r}
setwd("C:/Users/Xuele/Documents/MACHINE LEARNING/TEMA 6")
#setwd("C:/Users/Xuele/Documents/WeChat Files/wxid_rk9499725zdh11/FileStorage/File/2023-03/TEMA6")
library(parallel)
library(doParallel)
library(plyr)
library(caret)
library(dummies)
library(ggplot2)
library(randomForest)
library(naniar)
library(MASS)
library(caret)
library(MXM)
library(dplyr)
GS_T0 <- Sys.time()
cluster <- makeCluster(detectCores() - 1) # number of cores, convention to leave 1 core for OS
registerDoParallel(cluster) # register the parallel processing


source("funcion steprepetido binaria.R")
source("cruzadas avnnet y log binaria.R")


load("TRATACodificada.rda")

dput(names(TRATA))

```
c("situacion", "es_anonima", "provincia", "via_ingreso", "derivacion_institucion", 
"derivacion_judicializa", "denunciante_tipo", "denunciante_edad_aparente", 
"subtema1", "MESES", "weekday_ingreso", "localidad1", "denunciante_genero1", 
"dias_transcurridos", "hora_categ")


#Combinacion de datos 
```{r}

listconti<-c("dias_transcurridos")
listclass<-c("situacion", "es_anonima", "provincia", "via_ingreso", "derivacion_institucion", 
"derivacion_judicializa", "denunciante_tipo", "denunciante_edad_aparente", 
 "MESES", "weekday_ingreso", "denunciante_genero1", "hora_categ","nro_registro_interno")
vardep<-c("subtema1")
TRATA<-TRATA[,c(listconti,listclass,vardep)]

```

#Transformacion de datos 
```{r}
# Borro observaciones con algún missing 


TRATA2<-na.omit(TRATA)

# Copio  y pego de otros ejemplos estandarización continuas



TRATA2<-data.frame(cbind(TRATA2.2,TRATA2[,c(listclass,vardep)]))
TRATA2

load("TRATA_LOC_encoder.RDA")
ggplot(LOC,
       aes(y = subtema1, x = targetbinloc1)) +
  geom_point(alpha = 0.8) +
  labs(
    title = "Primer scatter plot",
    subtitle = "Datos de 1997",
    caption = "Autor: J. Álvarez")
load("TRATA_PROV_encoder.RDA")
ggplot(PROV,
       aes(y = nro_registro_interno, x = targetbin1)) +
  geom_point(alpha = 0.8) +
  labs(
    title = "Primer scatter plot",
    subtitle = "Datos de 1997",
    caption = "Autor: J. Álvarez")


UNIR <- merge(merge(PROV, LOC, all = TRUE), TRATA2, all = TRUE)



subset(UNIR, nro_registro_interno == 505051525)

dput(names(UNIR))

c("nro_registro_interno", "provincia", "subtema1", "targetbin1", 
"targetbinloc1", "localidad1", "dias_transcurridos", "situacion", 
"es_anonima", "via_ingreso", "derivacion_institucion", "derivacion_judicializa", 
"denunciante_tipo", "denunciante_edad_aparente", "MESES", "weekday_ingreso", 
"denunciante_genero1", "hora_categ")


listconti<-c("dias_transcurridos","targetbin1","targetbinloc1")
listclass<-c("situacion", "es_anonima",  "via_ingreso", "derivacion_institucion", 
"derivacion_judicializa", "denunciante_tipo", "denunciante_edad_aparente", 
 "MESES", "weekday_ingreso", "denunciante_genero1", "hora_categ")
vardep<-c("subtema1")

TRATA2<-UNIR[,c(listconti,listclass,vardep)]

write.xlsx(TRATA2, file = "TRATA_limpia_sindummy.xlsx", rowNames = FALSE) 
```



```{r}

# Lista de Frecuencias de las categóricas, útil pues algunos niveles
# con pocas observaciones no deben ser tenidos en cuenta 
# en modelos de machine learning para evitar sobreajuste


frecu<-ldply(TRATA2[,listclass],function(x) t(rbind(names(table(x)),table(x))))
names(frecu)<-c("variable","nivel","frecuencia")
frecu$frecuencia<-as.numeric(frecu$frecuencia)
frecu 

# Hacemos dummies
TRATAbis<-dummy.data.frame(TRATA2, listclass, sep = ".")

# Quitamos position o division con menos de 20
frecu20<-frecu[frecu$frecuencia<20,]

# 2) Obtengo listado de los niveles en el mismo formato que las dummies,
# con separador .

frecu20$dum<-paste(frecu20$variable,frecu20$nivel,sep=".")
listamal<-dput(frecu20$dum)

listamal
# Borro las dummies de basebis que coinciden con la lista
TRATAbis[,listamal]<-NULL


```


```{r}

TRATAbis

TRATAbis

```


#Transformacion de nombre dummy
```{r}


dput(names(TRATAbis))

colnames(TRATAbis)[colnames(TRATAbis) == "situacion.Emergencia"] <- "SITUACION1"
colnames(TRATAbis)[colnames(TRATAbis) == "situacion.Urgencia"] <- "SITUACION2"
colnames(TRATAbis)[colnames(TRATAbis) == "es_anonima.Sí"] <- "ANONIMO1"
colnames(TRATAbis)[colnames(TRATAbis) == "es_anonima.No"] <- "ANONIMO2"
colnames(TRATAbis)[colnames(TRATAbis) == "via_ingreso.NOLINEA145"] <- "VIA_INGRESO2"
colnames(TRATAbis)[colnames(TRATAbis) == "via_ingreso.Línea145"] <- "VIA_INGRESO1"
colnames(TRATAbis)[colnames(TRATAbis) == "derivacion_institucion.Servicios_de_emergencia"] <- "INST_DERIVAC1"
colnames(TRATAbis)[colnames(TRATAbis) == "derivacion_institucion.Programas_de_ayuda_a_víctimas"] <- "INST_DERIVAC2"
colnames(TRATAbis)[colnames(TRATAbis) == "derivacion_institucion.OrgSeguridad"] <- "INST_DERIVAC3"
colnames(TRATAbis)[colnames(TRATAbis) == "derivacion_institucion.Protex"] <- "INST_DERIVAC4"
colnames(TRATAbis)[colnames(TRATAbis) == "derivacion_judicializa.Otros"] <- "DERIVAC_JUDIC2"
colnames(TRATAbis)[colnames(TRATAbis) == "derivacion_judicializa.Sí"] <- "DERIVAC_JUDIC1"
colnames(TRATAbis)[colnames(TRATAbis) == "denunciante_tipo.Denunciante"] <- "DENUNCIANTE1"
colnames(TRATAbis)[colnames(TRATAbis) == "denunciante_tipo.DC"] <- "DENUNCIANTE2"
colnames(TRATAbis)[colnames(TRATAbis) == "denunciante_tipo.DI"] <- "DENUNCIANTE3"
colnames(TRATAbis)[colnames(TRATAbis) == "denunciante_tipo.DVD"] <- "DENUNCIANTE4"
colnames(TRATAbis)[colnames(TRATAbis) == "denunciante_tipo.DVI"] <- "DENUNCIANTE5"
colnames(TRATAbis)[colnames(TRATAbis) == "denunciante_tipo.Otros"] <- "DENUNCIANTE6"
colnames(TRATAbis)[colnames(TRATAbis) == "denunciante_edad_aparente.17a29"] <- "DENUNCIANTE_EDAD1"
colnames(TRATAbis)[colnames(TRATAbis) == "denunciante_edad_aparente.30a44"] <- "DENUNCIANTE_EDAD2"
colnames(TRATAbis)[colnames(TRATAbis) == "denunciante_edad_aparente.45a64"] <- "DENUNCIANTE_EDAD3"
colnames(TRATAbis)[colnames(TRATAbis) == "denunciante_edad_aparente.65+"] <- "DENUNCIANTE_EDAD4"
colnames(TRATAbis)[colnames(TRATAbis) == "denunciante_edad_aparente.Desconoce"] <- "DENUNCIANTE_EDAD5"
colnames(TRATAbis)[colnames(TRATAbis) == "MESES.Abril"] <- "MES_INGRESO4"
colnames(TRATAbis)[colnames(TRATAbis) == "MESES.Agosto"] <- "MES_INGRESO8"
colnames(TRATAbis)[colnames(TRATAbis) == "MESES.Diciembre"] <- "MES_INGRESO12"
colnames(TRATAbis)[colnames(TRATAbis) == "MESES.Enero"] <- "MES_INGRESO1"
colnames(TRATAbis)[colnames(TRATAbis) == "MESES.Febrero"] <- "MES_INGRESO2"
colnames(TRATAbis)[colnames(TRATAbis) == "MESES.Julio"] <- "MES_INGRESO7"
colnames(TRATAbis)[colnames(TRATAbis) == "MESES.Junio"] <- "MES_INGRESO6"
colnames(TRATAbis)[colnames(TRATAbis) == "MESES.Marzo"] <- "MES_INGRESO3"
colnames(TRATAbis)[colnames(TRATAbis) == "MESES.Mayo"] <- "MES_INGRESO5"
colnames(TRATAbis)[colnames(TRATAbis) == "MESES.Noviembre"] <- "MES_INGRESO11"
colnames(TRATAbis)[colnames(TRATAbis) == "MESES.Octubre"] <- "MES_INGRESO10"
colnames(TRATAbis)[colnames(TRATAbis) == "MESES.Septiembre"] <- "MES_INGRESO9"

colnames(TRATAbis)[colnames(TRATAbis) == "weekday_ingreso.domingo"] <- "WEEKDAY_INGRESO7"
colnames(TRATAbis)[colnames(TRATAbis) == "weekday_ingreso.jueves"] <- "WEEKDAY_INGRESO4"
colnames(TRATAbis)[colnames(TRATAbis) == "weekday_ingreso.lunes"] <- "WEEKDAY_INGRESO1"
colnames(TRATAbis)[colnames(TRATAbis) == "weekday_ingreso.martes"] <- "WEEKDAY_INGRESO2"
colnames(TRATAbis)[colnames(TRATAbis) == "weekday_ingreso.miércoles"] <- "WEEKDAY_INGRESO3"
colnames(TRATAbis)[colnames(TRATAbis) == "weekday_ingreso.sábado"] <- "WEEKDAY_INGRESO6"
colnames(TRATAbis)[colnames(TRATAbis) == "weekday_ingreso.viernes"] <- "WEEKDAY_INGRESO5"
colnames(TRATAbis)[colnames(TRATAbis) == "denunciante_genero1.Hombre"] <- "DENUNCIANTE_GENERO1"
colnames(TRATAbis)[colnames(TRATAbis) == "denunciante_genero1.Mujer"] <- "DENUNCIANTE_GENERO2"
colnames(TRATAbis)[colnames(TRATAbis) == "hora_categ.Madrugada"] <- "PARTE_DIA_DERIVAC1"
colnames(TRATAbis)[colnames(TRATAbis) == "hora_categ.Mañana"] <- "PARTE_DIA_DERIVAC2"

colnames(TRATAbis)[colnames(TRATAbis) == "hora_categ.Tarde"] <- "PARTE_DIA_DERIVAC3"
colnames(TRATAbis)[colnames(TRATAbis) == "hora_categ.Noche"] <- "PARTE_DIA_DERIVAC4"



dput(names(TRATAbis))

```

c("dias_transcurridos", "targetbin1", "targetbinloc1", "SITUACION1", 
"SITUACION2", "ANONIMO2", "ANONIMO1", "VIA_INGRESO2", "VIA_INGRESO1", 
"INST_DERIVAC1", "INST_DERIVAC2", "INST_DERIVAC3", "derivacion_institucion.OrgJusticia", 
"INST_DERIVAC4", "DERIVAC_JUDIC2", "DERIVAC_JUDIC1", "DENUNCIANTE1", 
"DENUNCIANTE2", "DENUNCIANTE3", "DENUNCIANTE4", "DENUNCIANTE5", 
"DENUNCIANTE6", "DENUNCIANTE_EDAD1", "DENUNCIANTE_EDAD2", "DENUNCIANTE_EDAD3", 
"DENUNCIANTE_EDAD4", "DENUNCIANTE_EDAD5", "MES_INGRESO4", "MES_INGRESO8", 
"MES_INGRESO12", "MES_INGRESO1", "MES_INGRESO2", "MES_INGRESO7", 
"MES_INGRESO6", "MES_INGRESO3", "MES_INGRESO5", "MES_INGRESO11", 
"MES_INGRESO10", "MES_INGRESO9", "WEEKDAY_INGRESO7", "WEEKDAY_INGRESO4", 
"WEEKDAY_INGRESO1", "WEEKDAY_INGRESO2", "WEEKDAY_INGRESO3", "WEEKDAY_INGRESO6", 
"WEEKDAY_INGRESO5", "DENUNCIANTE_GENERO1", "DENUNCIANTE_GENERO2", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2", "PARTE_DIA_DERIVAC3", 
"PARTE_DIA_DERIVAC4", "subtema1")



#Archivo1
```{r}

# PARA ALGUNOS PREPARO MATRICES X, Y

archivo1<-TRATAbis


vardep<-"subtema1"
nombres1<-c("dias_transcurridos", "targetbin1", "targetbinloc1", "SITUACION1", 
"SITUACION2", "ANONIMO2", "ANONIMO1", "VIA_INGRESO2", "VIA_INGRESO1", 
"INST_DERIVAC1", "INST_DERIVAC2", "INST_DERIVAC3", "derivacion_institucion.OrgJusticia", 
"INST_DERIVAC4", "DERIVAC_JUDIC2", "DERIVAC_JUDIC1", "DENUNCIANTE1", 
"DENUNCIANTE2", "DENUNCIANTE3", "DENUNCIANTE4", "DENUNCIANTE5", 
"DENUNCIANTE6", "DENUNCIANTE_EDAD1", "DENUNCIANTE_EDAD2", "DENUNCIANTE_EDAD3", 
"DENUNCIANTE_EDAD4", "DENUNCIANTE_EDAD5", "MES_INGRESO4", "MES_INGRESO8", 
"MES_INGRESO12", "MES_INGRESO1", "MES_INGRESO2", "MES_INGRESO7", 
"MES_INGRESO6", "MES_INGRESO3", "MES_INGRESO5", "MES_INGRESO11", 
"MES_INGRESO10", "MES_INGRESO9", "WEEKDAY_INGRESO7", "WEEKDAY_INGRESO4", 
"WEEKDAY_INGRESO1", "WEEKDAY_INGRESO2", "WEEKDAY_INGRESO3", "WEEKDAY_INGRESO6", 
"WEEKDAY_INGRESO5", "DENUNCIANTE_GENERO1", "DENUNCIANTE_GENERO2", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2", "PARTE_DIA_DERIVAC3", 
"PARTE_DIA_DERIVAC4")

y<-archivo1[,vardep]
x<-archivo1[,nombres1]

save(archivo1, file = "TRATACodificada_dummy_subtema.RDA")

write.xlsx(archivo1, file = "TRATA_limpia_dummy.xlsx", rowNames = FALSE) 

```






#Seleccion de variable

##AIC

```{r }
library(MASS)

# CON AIC

set.seed(1234)
full<-glm(factor(subtema1)~.,data=archivo1,family = binomial(link="logit"))
null<-glm(factor(subtema1)~1,data=archivo1,family = binomial(link="logit"))

selec1<-stepAIC(null,scope=list(upper=full),
                direction="both",family = binomial(link="logit"),trace=FALSE)

vec<-(names(selec1[[1]]))

length(vec)
#20 - 1 variables
dput(vec)




```
[1] 20
c("(Intercept)", "targetbinloc1", "ANONIMO1", "targetbin1", "DENUNCIANTE2", 
"MES_INGRESO3", "DENUNCIANTE6", "MES_INGRESO2", "INST_DERIVAC1", 
"PARTE_DIA_DERIVAC1", "WEEKDAY_INGRESO1", "INST_DERIVAC2", "PARTE_DIA_DERIVAC2", 
"MES_INGRESO11", "DERIVAC_JUDIC2", "DENUNCIANTE1", "MES_INGRESO4", 
"INST_DERIVAC4", "VIA_INGRESO2", "DENUNCIANTE_EDAD2")

##BIC
```{r }
# CON BIC, ponemos k=log(n) en stepAIC, en este caso n=1000 observaciones, k=7

set.seed(1234)
fullBIC<-glm(factor(subtema1)~.,data=archivo1,family = binomial(link="logit"))
nullBIC<-glm(factor(subtema1)~1,data=archivo1,family = binomial(link="logit"))

log(4619)
selecBIC<-stepAIC(nullBIC,scope=list(upper=fullBIC),
                direction="both",family = binomial(link="logit"),trace=FALSE,k=9)#K se puede manipular 

vecbic<-(names(selec1[[1]]))

length(vecbic)
#20 -1

dput(vecbic)

```

[1] 20
c("(Intercept)", "targetbinloc1", "ANONIMO1", "targetbin1", "DENUNCIANTE2", 
"MES_INGRESO3", "DENUNCIANTE6", "MES_INGRESO2", "INST_DERIVAC1", 
"PARTE_DIA_DERIVAC1", "WEEKDAY_INGRESO1", "INST_DERIVAC2", "PARTE_DIA_DERIVAC2", 
"MES_INGRESO11", "DERIVAC_JUDIC2", "DENUNCIANTE1", "MES_INGRESO4", 
"INST_DERIVAC4", "VIA_INGRESO2", "DENUNCIANTE_EDAD2")

#AS.FACTOR
```{r}
archivo1$subtema1<-as.factor(archivo1$subtema1)
```


##BORUTA
```{r }

clusters <- detectCores() - 1
make_cluster <- makeCluster(clusters)
registerDoParallel(make_cluster)
showConnections()

# BORUTA

# También vale como Filter
library(Boruta)
out.boruta <- Boruta(subtema1~., data = archivo1)

print(out.boruta)

summary(out.boruta)

sal<-data.frame(out.boruta$finalDecision)

sal2<-sal[which(sal$out.boruta.finalDecision=="Confirmed"),,drop=FALSE]
dput(row.names(sal2))

length(dput(row.names(sal2)))
#22 variables
```
c("targetbin1", "targetbinloc1", "SITUACION1", "SITUACION2", 
"ANONIMO2", "ANONIMO1", "VIA_INGRESO2", "VIA_INGRESO1", "INST_DERIVAC1", 
"INST_DERIVAC2", "INST_DERIVAC3", "INST_DERIVAC4", "DENUNCIANTE2", 
"DENUNCIANTE3", "DENUNCIANTE4", "DENUNCIANTE5", "MES_INGRESO8", 
"MES_INGRESO3", "WEEKDAY_INGRESO1", "DENUNCIANTE_GENERO1", "DENUNCIANTE_GENERO2", 
"PARTE_DIA_DERIVAC1")
[1] 22


##MXM
```{r }
# MXM

library(MXM)

mmpc2 <- MMPC(vardep, archivo1, max_k = 3, hash = TRUE,
              test = "testIndLogistic")

mmpc2@selectedVars

a<-dput(names(archivo1[,c(mmpc2@selectedVars)]))

length(a)
#10 variables
```

c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2")
[1] 10

#YES/NO
```{r}
# SIEMPRE VAMOS A PONER Yes,No, LA VARIABLE DEPENDIENTE EN LAS FUNCIONES a partir de ahora

TRATAbis$subtema1<-ifelse(TRATAbis$subtema1==1,"Yes","No")


archivo1<-TRATAbis


```

##RFE
```{r }
source("cruzadas avnnet y log binaria.R")

control1 <- rfeControl(functions=rfFuncs, method="cv", number=10)#number es  n de validacion cruzada 
# run the RFE algorithm
resultsRFE <- rfe(x, y, sizes=c(1:20), rfeControl=control1)
#hasta n de variables a considerar
cosa<-as.data.frame(resultsRFE$results)

#modelo con 1variable  modelo con 2 variables y su RMSE
cosa
# Resultados en gráfico  #MAE media absolut por error 

ggplot(cosa,aes(y=Accuracy, x=Variables))+geom_point()+geom_line()+ 
  scale_y_continuous(breaks = cosa$Accuracy) +
  scale_x_continuous(breaks = cosa$Variables)+labs(title="RFE")


# Pongo a partir de 4 variables
cosa2<-cosa[c(4:20),]#de 4 variable a 16 variables
ggplot(cosa2,aes(y=Accuracy, x=Variables))+geom_point()+geom_line()+ 
  scale_y_continuous(breaks = cosa$Accuracy) +
  scale_x_continuous(breaks = cosa$Variables)+labs(title="RFE")


selecrfe2.0<-resultsRFE$optVariables[1:16]  

dput(selecrfe2.0)
length(selecrfe2.0)

```


c("targetbinloc1", "ANONIMO2", "ANONIMO1", "targetbin1", "DENUNCIANTE2", 
"DENUNCIANTE3", "MES_INGRESO3", "INST_DERIVAC2", "WEEKDAY_INGRESO1", 
"DENUNCIANTE5", "DENUNCIANTE4", "SITUACION2", "INST_DERIVAC1", 
"PARTE_DIA_DERIVAC1", "DENUNCIANTE_EDAD5", "DENUNCIANTE_GENERO1"
)
[1] 16

##STEPAIC
```{r }

source("funcion steprepetido binaria.R")

lista<-steprepetidobinaria(data=archivo1,vardep=c("subtema1"),
                           listconti=nombres1,
                           sinicio=1234,sfinal=1256,porcen=0.8,criterio="AIC")



tabla<-lista[[1]]
dput(lista[[2]][[1]])
#17 variables
```
c("ANONIMO2", "targetbinloc1", "DENUNCIANTE2", "targetbin1", 
"DENUNCIANTE6", "MES_INGRESO3", "PARTE_DIA_DERIVAC1", "MES_INGRESO2", 
"MES_INGRESO11", "INST_DERIVAC1", "MES_INGRESO10", "PARTE_DIA_DERIVAC2", 
"MES_INGRESO9", "INST_DERIVAC2", "DENUNCIANTE1", "WEEKDAY_INGRESO4", 
"DENUNCIANTE_EDAD5")

17 variables





##STEPBIC
```{r }

listaBIC<-steprepetidobinaria(data=archivo1,vardep=c("subtema1"),
                           listconti=nombres1,
                           sinicio=1234,sfinal=1245,porcen=0.8,criterio="BIC")


tablaBIC<-listaBIC[[1]]

dput(listaBIC[[2]][[1]])
#6 variables 
c("targetbinloc1", "ANONIMO2", "targetbin1", "DENUNCIANTE2", 
"DENUNCIANTE6", "MES_INGRESO3")

dput(listaBIC[[2]][[2]])
#7 variables 
c("targetbinloc1", "ANONIMO2", "targetbin1", "DENUNCIANTE2", 
"MES_INGRESO3", "DENUNCIANTE6", "INST_DERIVAC1")
```
6 variables 
c("targetbinloc1", "ANONIMO2", "targetbin1", "DENUNCIANTE2", 
"DENUNCIANTE6", "MES_INGRESO3")


7 variables 
c("targetbinloc1", "ANONIMO2", "targetbin1", "DENUNCIANTE2", 
"MES_INGRESO3", "DENUNCIANTE6", "INST_DERIVAC1")

#Dato1
```{r}
data<-TRATAbis
```

##RF importance 
```{r }

library(randomForest)


set.seed(1234)
rfgrid<-expand.grid(mtry=c(3,4,5,6,7,8,9,10,11))

control<-trainControl(method = "cv",number=4,savePredictions = "all",
 classProbs=TRUE) 

rf<- train(factor(subtema1)~.,data=data,
 method="rf",trControl=control,tuneGrid=rfgrid,
 linout = FALSE,ntree=300,nodesize=10,replace=TRUE,
 importance=TRUE)

rf

# IMPORTANCIA DE VARIABLES

final<-rf$finalModel

tabla<-as.data.frame(importance(final))
tabla<-tabla[order(-tabla$MeanDecreaseAccuracy),]
tabla

barplot(tabla$MeanDecreaseAccuracy,names.arg=rownames(tabla))
dput(rownames(tabla))
#mtry = 10.

```
c("targetbinloc1", "targetbin1", "ANONIMO2", "ANONIMO1", "DENUNCIANTE3", 
"DENUNCIANTE2", "INST_DERIVAC2", "MES_INGRESO3", "WEEKDAY_INGRESO1", 
"PARTE_DIA_DERIVAC1", "DENUNCIANTE5")

11 variables

##GBM

```{r}
gbmgrid<-expand.grid(shrinkage=c(0.2,0.1,0.05,0.03,0.01,0.001),
 n.minobsinnode=c(5,10,20),
 n.trees=c(100,500,1000,5000),
 interaction.depth=c(2))

controlgbm<-trainControl(method = "cv",number=4,savePredictions = "all",
 classProbs=TRUE) 

gbm<- train(factor(subtema1)~.,data=data,
            method="gbm",trControl=controlgbm,tuneGrid=gbmgrid,
            distribution="bernoulli", bag.fraction=1,verbose=FALSE)#bag fraction no se puede turnear



gbm
 
plot(gbm)

# IMPORTANCIA DE VARIABLES
par(cex=1.3)
summary(gbm)

tablagbm<-summary(gbm)
par(cex=1.5,las=2)
barplot(tablagbm$rel.inf,names.arg=row.names(tablagbm)) #ver la importancia de las variables

dput(rownames(tablagbm))
```

n.trees = 5000, interaction.depth = 2, shrinkage
 = 0.01 and n.minobsinnode = 5

c("targetbinloc1", "ANONIMO1", "ANONIMO2", "targetbin1", "DENUNCIANTE2", 
"dias_transcurridos", "PARTE_DIA_DERIVAC1", "INST_DERIVAC1", 
"MES_INGRESO2", "MES_INGRESO3", "DENUNCIANTE3")

11 variables 


```{r}
# AQUÍ USO DETACH PUES HAY PAQUETES CON FUNCIONES CON LOS MISMOS nombres1Y DAN PROBLEMAS

detach(package:MXM)#olvidar este paquete
detach(package:Boruta)#olvidar este paquete, lo descargue

```

#Comparar seleccion de variable

##Media 0 RFE
```{r}


medias0<-cruzadalogistica(data=data,
                     vardep="subtema1",listconti=
                       c("targetbinloc1", "ANONIMO2", "ANONIMO1", "targetbin1", "DENUNCIANTE2", 
"DENUNCIANTE3", "MES_INGRESO3", "INST_DERIVAC2", "WEEKDAY_INGRESO1", 
"DENUNCIANTE5", "DENUNCIANTE4", "SITUACION2", "INST_DERIVAC1", 
"PARTE_DIA_DERIVAC1", "DENUNCIANTE_EDAD5", "DENUNCIANTE_GENERO1"),
                     listclass=c(""),grupos=4,sinicio=1234,repe=10)

medias0$modelo="RFE BIEN"
```

##Media 0.1 RFE
```{r}


medias0.1<-cruzadalogistica(data=data,
                     vardep="subtema1",listconti=
                       c("targetbinloc1", "ANONIMO2", "ANONIMO1", "targetbin1", "DENUNCIANTE2", 
"DENUNCIANTE3", "MES_INGRESO3", "INST_DERIVAC2", "WEEKDAY_INGRESO1", 
"DENUNCIANTE5", "DENUNCIANTE4", "SITUACION2", "INST_DERIVAC1", 
"PARTE_DIA_DERIVAC1", "DENUNCIANTE_EDAD5", "DENUNCIANTE_GENERO1"),
                     listclass=c(""),grupos=4,sinicio=1245,repe=10)

medias0.1$modelo="RFE BIEN1"
```

##Media 1 AIC
```{r}
data<-TRATAbis


medias1<-cruzadalogistica(data=data,
                          vardep="subtema1",listconti=c("targetbinloc1", "ANONIMO1", "targetbin1", "DENUNCIANTE2", 
"MES_INGRESO3", "DENUNCIANTE6", "MES_INGRESO2", "INST_DERIVAC1", 
"PARTE_DIA_DERIVAC1", "WEEKDAY_INGRESO1", "INST_DERIVAC2", "PARTE_DIA_DERIVAC2", 
"MES_INGRESO11", "DERIVAC_JUDIC2", "DENUNCIANTE1", "MES_INGRESO4", 
"INST_DERIVAC4", "VIA_INGRESO2", "DENUNCIANTE_EDAD2"),
                          listclass=c(""),grupos=4,sinicio=1234,repe=10)

medias1$modelo="AIC"
```

##Media 1.1 AIC
```{r}



medias1.1<-cruzadalogistica(data=data,
                          vardep="subtema1",listconti=c("targetbinloc1", "ANONIMO1", "targetbin1", "DENUNCIANTE2", 
"MES_INGRESO3", "DENUNCIANTE6", "MES_INGRESO2", "INST_DERIVAC1", 
"PARTE_DIA_DERIVAC1", "WEEKDAY_INGRESO1", "INST_DERIVAC2", "PARTE_DIA_DERIVAC2", 
"MES_INGRESO11", "DERIVAC_JUDIC2", "DENUNCIANTE1", "MES_INGRESO4", 
"INST_DERIVAC4", "VIA_INGRESO2", "DENUNCIANTE_EDAD2"),
                          listclass=c(""),grupos=4,sinicio=1245,repe=10)

medias1.1$modelo="AIC1"
```

##Media 2 BIC
```{r}
medias2<-cruzadalogistica(data=data,
                          vardep="subtema1",listconti=
                            c("targetbinloc1", "ANONIMO1", "targetbin1", "DENUNCIANTE2", 
"MES_INGRESO3", "DENUNCIANTE6", "MES_INGRESO2", "INST_DERIVAC1", 
"PARTE_DIA_DERIVAC1", "WEEKDAY_INGRESO1", "INST_DERIVAC2", "PARTE_DIA_DERIVAC2", 
"MES_INGRESO11", "DERIVAC_JUDIC2", "DENUNCIANTE1", "MES_INGRESO4", 
"INST_DERIVAC4", "VIA_INGRESO2", "DENUNCIANTE_EDAD2")
                          ,
                          listclass=c(""),grupos=4,sinicio=1234,repe=10)

medias2$modelo="BIC"
```


##Media 2.1 BIC
```{r}
medias2.1<-cruzadalogistica(data=data,
                          vardep="subtema1",listconti=
                            c("targetbinloc1", "ANONIMO1", "targetbin1", "DENUNCIANTE2", 
"MES_INGRESO3", "DENUNCIANTE6", "MES_INGRESO2", "INST_DERIVAC1", 
"PARTE_DIA_DERIVAC1", "WEEKDAY_INGRESO1", "INST_DERIVAC2", "PARTE_DIA_DERIVAC2", 
"MES_INGRESO11", "DERIVAC_JUDIC2", "DENUNCIANTE1", "MES_INGRESO4", 
"INST_DERIVAC4", "VIA_INGRESO2", "DENUNCIANTE_EDAD2")
                          ,
                          listclass=c(""),grupos=4,sinicio=1245,repe=10)

medias2.1$modelo="BIC1"
```

##Media 3 STEPAIC1
```{r}
medias3<-cruzadalogistica(data=data,
                          vardep="subtema1",listconti=
                            c("ANONIMO2", "targetbinloc1", "DENUNCIANTE2", "targetbin1", 
"DENUNCIANTE6", "MES_INGRESO3", "PARTE_DIA_DERIVAC1", "MES_INGRESO2", 
"MES_INGRESO11", "INST_DERIVAC1", "MES_INGRESO10", "PARTE_DIA_DERIVAC2", 
"MES_INGRESO9", "INST_DERIVAC2", "DENUNCIANTE1", "WEEKDAY_INGRESO4", 
"DENUNCIANTE_EDAD5"),
                          listclass=c(""),grupos=4,sinicio=1234,repe=10)

medias3$modelo="STEPrep1.AIC"

```


##Media 3.1 STEPAIC1
```{r}
medias3.1<-cruzadalogistica(data=data,
                          vardep="subtema1",listconti=
                            c("ANONIMO2", "targetbinloc1", "DENUNCIANTE2", "targetbin1", 
"DENUNCIANTE6", "MES_INGRESO3", "PARTE_DIA_DERIVAC1", "MES_INGRESO2", 
"MES_INGRESO11", "INST_DERIVAC1", "MES_INGRESO10", "PARTE_DIA_DERIVAC2", 
"MES_INGRESO9", "INST_DERIVAC2", "DENUNCIANTE1", "WEEKDAY_INGRESO4", 
"DENUNCIANTE_EDAD5"),
                          listclass=c(""),grupos=4,sinicio=1245,repe=10)

medias3.1$modelo="STEPrep1.AIC1"

```

##Media 4 STEPBIC1
```{r}
medias4<-cruzadalogistica(data=data,
                          vardep="subtema1",listconti=
                            c("targetbinloc1", "ANONIMO2", "targetbin1", "DENUNCIANTE2", 
"DENUNCIANTE6", "MES_INGRESO3")
                          
                          ,
                          listclass=c(""),grupos=4,sinicio=1234,repe=10)

medias4$modelo="STEPrep1.BIC"
```

##Media 4.1 STEPBIC1
```{r}
medias4.1<-cruzadalogistica(data=data,
                          vardep="subtema1",listconti=
                            c("targetbinloc1", "ANONIMO2", "targetbin1", "DENUNCIANTE2", 
"DENUNCIANTE6", "MES_INGRESO3")
                          
                          ,
                          listclass=c(""),grupos=4,sinicio=1245,repe=10)

medias4.1$modelo="STEPrep1.BIC1"
```

##Media 5 STEPBIC2
```{r}
medias5<-cruzadalogistica(data=data,
                          vardep="subtema1",listconti=
                            c("targetbinloc1", "ANONIMO2", "targetbin1", "DENUNCIANTE2", 
"MES_INGRESO3", "DENUNCIANTE6", "INST_DERIVAC1")
                          ,
                          listclass=c(""),grupos=4,sinicio=1234,repe=10)

medias5$modelo="STEPrep2.BIC"

```


##Media 5.1 STEPBIC2
```{r}
medias5.1<-cruzadalogistica(data=data,
                          vardep="subtema1",listconti=
                            c("targetbinloc1", "ANONIMO2", "targetbin1", "DENUNCIANTE2", 
"MES_INGRESO3", "DENUNCIANTE6", "INST_DERIVAC1")
                          ,
                          listclass=c(""),grupos=4,sinicio=1245,repe=10)

medias5.1$modelo="STEPrep2.BIC1"

```

##Media 6 BORUTA
```{r}
medias6<-cruzadalogistica(data=data,
                          vardep="subtema1",listconti=
                            c("targetbin1", "targetbinloc1", "SITUACION1", "SITUACION2", 
"ANONIMO2", "ANONIMO1", "VIA_INGRESO2", "VIA_INGRESO1", "INST_DERIVAC1", 
"INST_DERIVAC2", "INST_DERIVAC3", "INST_DERIVAC4", "DENUNCIANTE2", 
"DENUNCIANTE3", "DENUNCIANTE4", "DENUNCIANTE5", "MES_INGRESO8", 
"MES_INGRESO3", "WEEKDAY_INGRESO1", "DENUNCIANTE_GENERO1", "DENUNCIANTE_GENERO2", 
"PARTE_DIA_DERIVAC1")
                          
                          ,
                          listclass=c(""),grupos=4,sinicio=1234,repe=10)

medias6$modelo="Boruta"

```


##Media 6.1 BORUTA
```{r}
medias6.1<-cruzadalogistica(data=data,
                          vardep="subtema1",listconti=
                            c("targetbin1", "targetbinloc1", "SITUACION1", "SITUACION2", 
"ANONIMO2", "ANONIMO1", "VIA_INGRESO2", "VIA_INGRESO1", "INST_DERIVAC1", 
"INST_DERIVAC2", "INST_DERIVAC3", "INST_DERIVAC4", "DENUNCIANTE2", 
"DENUNCIANTE3", "DENUNCIANTE4", "DENUNCIANTE5", "MES_INGRESO8", 
"MES_INGRESO3", "WEEKDAY_INGRESO1", "DENUNCIANTE_GENERO1", "DENUNCIANTE_GENERO2", 
"PARTE_DIA_DERIVAC1")
                          
                          ,
                          listclass=c(""),grupos=4,sinicio=1245,repe=10)

medias6.1$modelo="Boruta1"

```

##Media 7 MXM
```{r}
medias7<-cruzadalogistica(data=data,
                          vardep="subtema1",listconti=
                            c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2")
                          ,
                          listclass=c(""),grupos=4,sinicio=1234,repe=10)

medias7$modelo="MXM"

```

##Media 7.1 MXM
```{r}
medias7.1<-cruzadalogistica(data=data,
                          vardep="subtema1",listconti=
                            c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2")
                          ,
                          listclass=c(""),grupos=4,sinicio=1245,repe=10)

medias7.1$modelo="MXM1"

```

##Media 8 RF
```{r }
mediasrf<-cruzadalogistica(data=data,
                    vardep="subtema1",listconti=
                      c("targetbinloc1", "targetbin1", "ANONIMO2", "ANONIMO1", "DENUNCIANTE3", 
"DENUNCIANTE2", "INST_DERIVAC2", "MES_INGRESO3", "WEEKDAY_INGRESO1", 
"PARTE_DIA_DERIVAC1", "DENUNCIANTE5"),
                    listclass=c(""),grupos=4,sinicio=1234,repe=10)

mediasrf$modelo="RF importance"
```

##Media 8.1 RF
```{r }
mediasrf1<-cruzadalogistica(data=data,
                    vardep="subtema1",listconti=
                      c("targetbinloc1", "targetbin1", "ANONIMO2", "ANONIMO1", "DENUNCIANTE3", 
"DENUNCIANTE2", "INST_DERIVAC2", "MES_INGRESO3", "WEEKDAY_INGRESO1", 
"PARTE_DIA_DERIVAC1", "DENUNCIANTE5"),
                    listclass=c(""),grupos=4,sinicio=1245,repe=10)

mediasrf1$modelo="RF importance1"
```


##Media 9 Gmb
```{r }
mediasgmb<-cruzadalogistica(data=data,
                    vardep="subtema1",listconti=
                      c("targetbinloc1", "ANONIMO1", "ANONIMO2", "targetbin1", "DENUNCIANTE2", 
"dias_transcurridos", "PARTE_DIA_DERIVAC1", "INST_DERIVAC1", 
"MES_INGRESO2", "MES_INGRESO3", "DENUNCIANTE3"),
                    listclass=c(""),grupos=4,sinicio=1234,repe=10)

mediasgmb$modelo="Gmb"
```


#Union0
```{r}
# Union0<-rbind(medias0.1,medias1.1,medias2.1,medias3.1,medias4.1,medias5.1,medias6.1,medias7.1,mediasrf1,mediasgmb)

Union0<-rbind(medias0,medias1,medias2,medias3,medias4,medias5,medias6,medias7,mediasrf,mediasgmb)

par(cex.axis=0.4)
boxplot(data=Union0,col="pink",tasa~modelo,main="TASA DE FALLOS")


par(cex.axis=0.4)
boxplot(data=Union0,col="pink",auc~modelo,main="AUC")

dput(names(table(Union0$modelo)))

# nvar<-c(19,19,22,11,10,11,16,17,6,7)

nvar<-c(19,19,22,11,10,11,16,17,6,7)

nvarsdg <- paste(nvar, "var.")

# ESTO PARA CONTROLAR LOS EJES Y POSICION DE LA ETIQUETA

Union0$auc<-(Union0$auc)


max_auc <- max(Union0$auc)
min_auc <- min(Union0$auc)
num_modelos <- length(unique(Union0$modelo))


# Crear el boxplot y agregar las etiquetas
par(cex.axis=0.4)
boxplot(data=Union0,col="pink",auc~modelo,main="AUC",ylim=c(min_auc, max_auc*1.01))
text(x = seq(1:num_modelos), y = rep(max_auc, num_modelos), labels = nvarsdg, pos = 3,col="red")
axis(1, at=pretty(range(Union0$auc),n=9))

```



#Union1
```{r}
union1<-rbind(medias0,medias2,medias3,medias6,medias7,mediasrf)

par(cex.axis=0.8)
boxplot(data=union1,col="pink",tasa~modelo,main="TASA DE FALLOS")


par(cex.axis=0.7)
boxplot(data=union1,col="pink",auc~modelo,main="AUC")



```
#Union2
```{r}

#seleccion de variables finales 

union2<-rbind(medias0,medias0.1,medias2,medias2.1,medias3,medias3.1,medias7,medias7.1,mediasrf,mediasrf1,mediasgmb)

par(cex.axis=0.8)
boxplot(data=union2,col="pink",tasa~modelo,main="TASA DE FALLOS")


par(cex.axis=0.7)
boxplot(data=union2,col="pink",auc~modelo,main="AUC")

# ESTO PARA DECIR CUANTAS VARIABLES TIENE CADA MODELO

dput(names(table(union2$modelo)))

nvar<-c(19,19,11,10,10,11,11,16,16,17,17)

nvar2 <- paste(nvar, "var.")

# ESTO PARA CONTROLAR LOS EJES Y POSICION DE LA ETIQUETA

union2$auc<-(union2$auc)


max_auc <- max(union2$auc)
min_auc <- min(union2$auc)
num_modelos <- length(unique(union2$modelo))


# Crear el boxplot y agregar las etiquetas
par(cex.axis=0.6,las=2)
boxplot(data=union2,col="pink",auc~modelo,main="auc",ylim=c(min_auc, max_auc*1.01))
text(x = seq(1:num_modelos), y = rep(max_auc, num_modelos), labels = nvar2, pos = 4,col="red")
axis(2, at=pretty(range(union2$auc),n=20))
```
Quedamos con el STEPprepAIC1 ,con 17 variables

c("ANONIMO2", "targetbinloc1", "DENUNCIANTE2", "targetbin1", 
"DENUNCIANTE6", "MES_INGRESO3", "PARTE_DIA_DERIVAC1", "MES_INGRESO2", 
"MES_INGRESO11", "INST_DERIVAC1", "MES_INGRESO10", "PARTE_DIA_DERIVAC2", 
"MES_INGRESO9", "INST_DERIVAC2", "DENUNCIANTE1", "WEEKDAY_INGRESO4", 
"DENUNCIANTE_EDAD5")

Calculos: 17 variables, 4619 obs , con 30 obs por parametro implica 4619/30=153.9667 parmetros max.
153.9667/12=12.83056 nodos max.


#Data2 STEPAIC
```{r}

vardep="subtema1"
variables<-c("ANONIMO2", "targetbinloc1", "DENUNCIANTE2", "targetbin1", 
"DENUNCIANTE6", "MES_INGRESO3", "PARTE_DIA_DERIVAC1", "MES_INGRESO2", 
"MES_INGRESO11", "INST_DERIVAC1", "MES_INGRESO10", "PARTE_DIA_DERIVAC2", 
"MES_INGRESO9", "INST_DERIVAC2", "DENUNCIANTE1", "WEEKDAY_INGRESO4", 
"DENUNCIANTE_EDAD5")
#hay que quitar las comilla simple 

data2<-data[,c(variables,vardep)]

write.xlsx(data2, file = "TRATA_limpia_stepaic.xlsx", rowNames = FALSE) 

```




#RED MAXIT.Tuneo complejo con STEPAIC
```{r }


controlmaxi<-trainControl(method = "cv",
                      number=4,savePredictions = "all") 

set.seed(1234)
nnetgridmaxi <-  expand.grid(size=c(3,4,6,9,10,12),decay=c(0.01,0.1,0.001,0.0001),bag=F)

completomaxi<-data.frame()
listaitermaxi<-c(20,30,50,100,200,300,500,1000,2000,3000,5000)

for (iter in listaitermaxi)
{
  rednnetmaxi<- train(subtema1~ANONIMO2+ targetbinloc1+ DENUNCIANTE2+ targetbin1+ 
DENUNCIANTE6+ MES_INGRESO3+ PARTE_DIA_DERIVAC1+ MES_INGRESO2+ 
MES_INGRESO11+ INST_DERIVAC1+ MES_INGRESO10+ PARTE_DIA_DERIVAC2+ 
MES_INGRESO9+ INST_DERIVAC2+ DENUNCIANTE1+ WEEKDAY_INGRESO4+ 
DENUNCIANTE_EDAD5,
                  data=data2,
                  method="avNNet",linout = TRUE,maxit=iter,
                  trControl=controlmaxi,repeats=5,tuneGrid=nnetgridmaxi,trace=F)
  # Añado la columna del parametro de iteraciones
  rednnetmaxi$results$itera<-iter
  # Voy incorporando los resultados a completo
  completomaxi<-rbind(completomaxi,rednnetmaxi$results)
  
  
}

completomaxi<-completomaxi[order(completomaxi$Accuracy),]

ggplot(completomaxi, aes(x=factor(itera), y=Accuracy, 
                     color=factor(decay),pch=factor(size))) +
  geom_point(position=position_dodge(width=0.5),size=3)
```

Decay 0,001, 9 factor , 1000iter


##Media 10 Red con maxit0
```{r}

source("cruzadas avnnet y log binaria.R")
medias10<-cruzadaavnnetbin(data=data2,
                          vardep="subtema1",listconti=
                            c("ANONIMO2", "targetbinloc1", "DENUNCIANTE2", "targetbin1", 
"DENUNCIANTE6", "MES_INGRESO3", "PARTE_DIA_DERIVAC1", "MES_INGRESO2", 
"MES_INGRESO11", "INST_DERIVAC1", "MES_INGRESO10", "PARTE_DIA_DERIVAC2", 
"MES_INGRESO9", "INST_DERIVAC2", "DENUNCIANTE1", "WEEKDAY_INGRESO4", 
"DENUNCIANTE_EDAD5"),
                          listclass=c(""),grupos=4,sinicio=1234,repe=25,repeticiones=5,itera=1000,
                          size=c(9),decay=c(0.001))
medias10$modelo="Red con maxit0"


```




#Data3 MXM

seleccion de variable MXM 13 variables 
```{r}

vardep="subtema1"
variables3<-c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2")
#hay que quitar las comilla simple 

data3<-data[,c(variables3,vardep)]

# write.xlsx(data3, file = "TRATA_limpia_mxm.xlsx", rowNames = FALSE) 

```

#RED MAXIT.Tuneo complejo con MXM
```{r}


controlmaxi<-trainControl(method = "cv",
                      number=4,savePredictions = "all") 

set.seed(1234)
nnetgridmaxi <-  expand.grid(size=c(3,4,6,9,10,12),decay=c(0.01,0.1,0.001,0.0001),bag=F)

completomaxi1<-data.frame()
listaitermaxi<-c(20,30,50,100,200,300,500,1000,2000,3000,5000)

for (iter in listaitermaxi)
{
  rednnetmaxi1<- train(subtema1~targetbin1+ targetbinloc1+ ANONIMO1+ INST_DERIVAC1+ 
DENUNCIANTE2+ DENUNCIANTE3+ MES_INGRESO2+ MES_INGRESO3+ 
PARTE_DIA_DERIVAC1+ PARTE_DIA_DERIVAC2,
                  data=data3,
                  method="avNNet",linout = TRUE,maxit=iter,
                  trControl=controlmaxi,repeats=5,tuneGrid=nnetgridmaxi,trace=F)
  # Añado la columna del parametro de iteraciones
  rednnetmaxi1$results$itera<-iter
  # Voy incorporando los resultados a completo
  completomaxi1<-rbind(completomaxi1,rednnetmaxi1$results)
  
  
}

completomaxi1<-completomaxi1[order(completomaxi1$Accuracy),]

ggplot(completomaxi1, aes(x=factor(itera), y=Accuracy, 
                     color=factor(decay),pch=factor(size))) +
  geom_point(position=position_dodge(width=0.5),size=3)
```
Decay 0,0001, 4 factor, 1000 iter


##Media11 redmaxi1
```{r}
medias11<-cruzadaavnnetbin(data=data3,
                          vardep="subtema1",listconti=
                            c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2"),
                          listclass=c(""),grupos=4,sinicio=1234,repe=25,repeticiones=5,itera=1000,
                          size=c(4),decay=c(0.0001))

medias11$modelo="Red con maxit1"

```


#Union3
```{r}
Union3<-rbind(medias11,medias10)

par(cex.axis=0.8)
boxplot(data=Union3,col="pink",tasa~modelo,main="TASA DE FALLOS")


par(cex.axis=0.7)
boxplot(data=Union3,col="pink",auc~modelo,main="AUC")

# ESTO PARA DECIR CUANTAS VARIABLES TIENE CADA MODELO

dput(names(table(Union3$modelo)))

nvar<-c(17,10)

nvar2 <- paste(nvar, "var.")

# ESTO PARA CONTROLAR LOS EJES Y POSICION DE LA ETIQUETA

Union3$auc<-(Union3$auc)


max_auc <- max(Union3$auc)
min_auc <- min(Union3$auc)
num_modelos <- length(unique(Union3$modelo))


# Crear el boxplot y agregar las etiquetas
par(cex.axis=0.6,las=2)
boxplot(data=Union3,col="pink",auc~modelo,main="auc",ylim=c(min_auc, max_auc*1.01))
text(x = seq(1:num_modelos), y = rep(max_auc, num_modelos), labels = nvar2, pos = 4,col="red")
axis(2, at=pretty(range(Union3$auc),n=20))
```


El mejor combinacion para hacer red neuronal es el de MXM, con 10 variablesy con  itera=1000, size=c(4),decay=c(0.0001)).  




#Union3.1
```{r}
Union3.1<-rbind(medias3,medias7, medias11,medias10)

par(cex.axis=0.8)
boxplot(data=Union3.1,col="pink",tasa~modelo,main="TASA DE FALLOS")


par(cex.axis=0.7)
boxplot(data=Union3.1,col="pink",auc~modelo,main="AUC")

# ESTO PARA DECIR CUANTAS VARIABLES TIENE CADA MODELO

dput(names(table(Union3.1$modelo)))

nvar<-c(10,17,10,17)

nvar2 <- paste(nvar, "var.")

# ESTO PARA CONTROLAR LOS EJES Y POSICION DE LA ETIQUETA

Union3.1$auc<-(Union3.1$auc)


max_auc <- max(Union3.1$auc)
min_auc <- min(Union3.1$auc)
num_modelos <- length(unique(Union3.1$modelo))


# Crear el boxplot y agregar las etiquetas
par(cex.axis=0.6,las=2)
boxplot(data=Union3.1,col="pink",auc~modelo,main="auc",ylim=c(min_auc, max_auc*1.01))
text(x = seq(1:num_modelos), y = rep(max_auc, num_modelos), labels = nvar2, pos = 4,col="red")
axis(2, at=pretty(range(Union3$auc),n=20))
```

#Bagging STEPAIC
```{r}
rfgridbag<-expand.grid(mtry=c(10))

set.seed(1234)

controlbag<-trainControl(method = "cv",number=4,savePredictions = "all",
 classProbs=TRUE) 

rfbag<- train(data=data2,
 factor(subtema1)~ANONIMO2+ targetbinloc1+ DENUNCIANTE2+ targetbin1+ 
DENUNCIANTE6+ MES_INGRESO3+ PARTE_DIA_DERIVAC1+ MES_INGRESO2+ 
MES_INGRESO11+ INST_DERIVAC1+ MES_INGRESO10+ PARTE_DIA_DERIVAC2+ 
MES_INGRESO9+ INST_DERIVAC2+ DENUNCIANTE1+ WEEKDAY_INGRESO4+ 
DENUNCIANTE_EDAD5,
 method="rf",trControl=controlbag,tuneGrid=rfgridbag,
 linout = FALSE,ntree=5000,nodesize=10,replace=TRUE, importance=T)#replace es true,significa que es con replaczamiento 

rfbag
# PARA PLOTEAR EL ERROR OOB A MEDIDA QUE AVANZAN LAS ITERACIONES
# SE USA DIRECTAMENTE EL PAQUETE randomForest

library(randomForest)
set.seed(1234)

rfbisbag<-randomForest(factor(subtema1)~ANONIMO2+ targetbinloc1+ DENUNCIANTE2+ targetbin1+ 
DENUNCIANTE6+ MES_INGRESO3+ PARTE_DIA_DERIVAC1+ MES_INGRESO2+ 
MES_INGRESO11+ INST_DERIVAC1+ MES_INGRESO10+ PARTE_DIA_DERIVAC2+ 
MES_INGRESO9+ INST_DERIVAC2+ DENUNCIANTE1+ WEEKDAY_INGRESO4+ 
DENUNCIANTE_EDAD5,
 data=data2,
 mtry=6,ntree=5000,sampsize=300,nodesize=10,replace=TRUE)

plot(rfbisbag$err.rate[,1])
```

Empieza a estabilizar el error  a apartir de 3000 arboles

```{r}
source ("cruzadas avnnet y log binaria.R")
source ("cruzada arbolbin.R")
source ("cruzada rf binaria.R")
```

##Media 12
```{r}
  medias12<-cruzadarfbin(data=data2, vardep="subtema1",
   listconti=c("ANONIMO2", "targetbinloc1", "DENUNCIANTE2", "targetbin1", 
"DENUNCIANTE6", "MES_INGRESO3", "PARTE_DIA_DERIVAC1", "MES_INGRESO2", 
"MES_INGRESO11", "INST_DERIVAC1", "MES_INGRESO10", "PARTE_DIA_DERIVAC2", 
"MES_INGRESO9", "INST_DERIVAC2", "DENUNCIANTE1", "WEEKDAY_INGRESO4", 
"DENUNCIANTE_EDAD5"),
 listclass=c(""),
  grupos=10,sinicio=1234,repe=25,nodesize=10,
  mtry=10,ntree=3000,replace=TRUE,sampsize=50)#tunear sampsize, es el tamaño de muestra que vamos a turnear 

      medias12$modelo="baggingTEAP50"
      
       
```    



##Media 13
```{r}

    medias13<-cruzadarfbin(data=data2, vardep="subtema1",
   listconti=c("ANONIMO2", "targetbinloc1", "DENUNCIANTE2", "targetbin1", 
"DENUNCIANTE6", "MES_INGRESO3", "PARTE_DIA_DERIVAC1", "MES_INGRESO2", 
"MES_INGRESO11", "INST_DERIVAC1", "MES_INGRESO10", "PARTE_DIA_DERIVAC2", 
"MES_INGRESO9", "INST_DERIVAC2", "DENUNCIANTE1", "WEEKDAY_INGRESO4", 
"DENUNCIANTE_EDAD5"),
 listclass=c(""),
  grupos=10,sinicio=1234,repe=25,nodesize=10,
  mtry=10,ntree=3000,replace=TRUE,sampsize=100)

      medias13$modelo="baggingTEAP100"
```    





#Bagging MXM
```{r}
rfgridbag<-expand.grid(mtry=c(10))

set.seed(1234)

controlbag<-trainControl(method = "cv",number=4,savePredictions = "all",
 classProbs=TRUE) 

rfbagmxm<- train(data=data3,
 factor(subtema1)~targetbin1+ targetbinloc1+ ANONIMO1+ INST_DERIVAC1+ 
DENUNCIANTE2+ DENUNCIANTE3+ MES_INGRESO2+ MES_INGRESO3+ 
PARTE_DIA_DERIVAC1+ PARTE_DIA_DERIVAC2,
 method="rf",trControl=controlbag,tuneGrid=rfgridbag,
 linout = FALSE,ntree=5000,nodesize=10,replace=TRUE, importance=T)#replace es true,significa que es con replaczamiento 

rfbagmxm
# PARA PLOTEAR EL ERROR OOB A MEDIDA QUE AVANZAN LAS ITERACIONES
# SE USA DIRECTAMENTE EL PAQUETE randomForest

library(randomForest)
set.seed(12345)

rfbisbagmxm<-randomForest(factor(subtema1)~targetbin1+ targetbinloc1+ ANONIMO1+ INST_DERIVAC1+ 
DENUNCIANTE2+ DENUNCIANTE3+ MES_INGRESO2+ MES_INGRESO3+ 
PARTE_DIA_DERIVAC1+ PARTE_DIA_DERIVAC2,
 data=data3,
 mtry=10,ntree=5000,sampsize=300,nodesize=10,replace=TRUE)

plot(rfbisbagmxm$err.rate[,1])
```


##Media 14
```{r}    
      medias14<-cruzadarfbin(data=data3, vardep="subtema1",
   listconti=c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2"),
 listclass=c(""),
  grupos=10,sinicio=1234,repe=25,nodesize=20,
  mtry=10,ntree=1500,replace=TRUE,sampsize=300)

  medias14$modelo="baggingMXM20-300"
  
  medias14bis<-as.data.frame(medias14[1])
medias14bis$modelo<-"baggingMXM20-300"
```    


##Media 15
```{r}
    medias15<-cruzadarfbin(data=data3, vardep="subtema1",
   listconti=c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2"),
 listclass=c(""),
  grupos=10,sinicio=1234,repe=25,nodesize=20,
  mtry=10,ntree=3000,replace=TRUE,sampsize=500)

  medias15$modelo="baggingMXM20-500"
  
   medias15bis<-as.data.frame(medias15[1])
medias15bis$modelo<-"baggingMXM20-500"
```    

##media 16
```{r}  
medias16<-cruzadarfbin(data=data3, vardep="subtema1",
   listconti=c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2"),
 listclass=c(""),
  grupos=10,sinicio=1234,repe=25,nodesize=20,
  mtry=10,ntree=1500,replace=TRUE,sampsize=800)

  medias16$modelo="baggingMXM20-800"
  
  medias16bis<-as.data.frame(medias16[1])
medias16bis$modelo<-"baggingMXM20-800"
```    

##Media 17
```{r}
  medias17<-cruzadarfbin(data=data3, vardep="subtema1",
   listconti=c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2"),
 listclass=c(""),
  grupos=10,sinicio=1234,repe=25,nodesize=20,
  mtry=10,ntree=1500,replace=TRUE,sampsize=1500)#tunear sampsize, es el tamaño de muestra que vamos a turnear 

      medias17$modelo="baggingMXM20-1500"
      
      medias17bis<-as.data.frame(medias17[1])
medias17bis$modelo<-"baggingMXM20-1500"
```    



##Media 18
```{r}

  medias18<-cruzadarfbin(data=data3, vardep="subtema1",
   listconti=c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2"),
 listclass=c(""),
  grupos=10,sinicio=1234,repe=25,nodesize=30,
  mtry=10,ntree=1500,replace=TRUE,sampsize=300)#tunear sampsize, es el tamaño de muestra que vamos a turnear 

      medias18$modelo="baggingMXM30-300"
      
      medias18bis<-as.data.frame(medias18[1])
medias18bis$modelo<-"baggingMXM30-300"
```    


##Media 19
```{r}    
      medias19<-cruzadarfbin(data=data3, vardep="subtema1",
   listconti=c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2"),
 listclass=c(""),
  grupos=10,sinicio=1234,repe=25,nodesize=30,
  mtry=10,ntree=1500,replace=TRUE,sampsize=500)


      medias19$modelo="baggingMXM30-500"
      
      medias19bis<-as.data.frame(medias19[1])
medias19bis$modelo<-"baggingMXM30-500"
```    


##Media 20
```{r}
    medias20<-cruzadarfbin(data=data3, vardep="subtema1",
   listconti=c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2"),
 listclass=c(""),
  grupos=10,sinicio=1234,repe=25,nodesize=30,
  mtry=10,ntree=1500,replace=TRUE,sampsize=800)

      medias20$modelo="baggingMXM30-800"
      
       medias20bis<-as.data.frame(medias20[1])
medias20bis$modelo<-"baggingMXM30-800"
```    


##*Media 21
```{r}  
medias21<-cruzadarfbin(data=data3, vardep="subtema1",
   listconti=c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2"),
 listclass=c(""),
  grupos=10,sinicio=1234,repe=25,nodesize=30,
  mtry=10,ntree=1500,replace=TRUE,sampsize=1500)

  medias21$modelo="baggingMXM1500"
  
   medias21bis<-as.data.frame(medias21[1])
medias21bis$modelo<-"baggingMXM30-1500"



```  

#Union4
```{r}
# union4<-rbind(medias14bis,medias15bis,medias16bis,medias17bis)

# union4<-rbind(medias18bis,medias19bis,medias20bis,medias21bis)

union4<-rbind(medias16bis,medias20bis)

dput(names(table(union4$modelo)))
par(cex.axis=0.8)
boxplot(data=union4,col="pink",tasa~modelo,main="TASA DE FALLOS")


par(cex.axis=0.7)
boxplot(data=union4,col="pink",auc~modelo,main="AUC")



```
El mejor combinacion es bagging con set de variables MXM (10variables) y  mtry=10,ntree=3000,replace=TRUE,sampsize=300

#Random forest stepaic
```{r }
library(caret)
set.seed(1234) 

rfgridrf<-expand.grid(mtry=c(3,4,5,6,7,8,9,10,11))

controlrf<-trainControl(method = "cv",number=4,savePredictions = "all") 

rf1<- train(factor(subtema1)~ANONIMO2+ targetbinloc1+ DENUNCIANTE2+ targetbin1+ 
DENUNCIANTE6+ MES_INGRESO3+ PARTE_DIA_DERIVAC1+ MES_INGRESO2+ 
MES_INGRESO11+ INST_DERIVAC1+ MES_INGRESO10+ PARTE_DIA_DERIVAC2+ 
MES_INGRESO9+ INST_DERIVAC2+ DENUNCIANTE1+ WEEKDAY_INGRESO4+ 
DENUNCIANTE_EDAD5,
            data=data2, method="rf",trControl=controlrf,tuneGrid=rfgridrf, linout = FALSE,ntree=3000,nodesize=20,replace=TRUE, importance=TRUE) 


rf1

# IMPORTANCIA DE VARIABLES

final1<-rf1$finalModel

tablastep<-as.data.frame(importance(final1))
tablastep<-tablastep[order(-tablastep$MeanDecreaseAccuracy),]
tablastep

barplot(tablastep$MeanDecreaseAccuracy,names.arg=rownames(tablastep))
dput(rownames(tablastep))
#mtry = 9

```
The final value used for the model was mtry = 9

#Random forest MXM
```{r }
library(caret)
set.seed(1234) 

rfgridrf<-expand.grid(mtry=c(3,4,5,6,7,8,9,10,11))

controlrf<-trainControl(method = "cv",number=4,savePredictions = "all") 

rfmxm<- train( factor(subtema1)~targetbin1+ targetbinloc1+ ANONIMO1+ INST_DERIVAC1+ 
DENUNCIANTE2+ DENUNCIANTE3+ MES_INGRESO2+ MES_INGRESO3+ 
PARTE_DIA_DERIVAC1+ PARTE_DIA_DERIVAC2,
            data=data3, method="rf",trControl=controlrf,tuneGrid=rfgridrf, linout = FALSE,ntree=3000,nodesize=20,replace=TRUE, importance=TRUE) 


rfmxm
# IMPORTANCIA DE VARIABLES

finalmxm<-rfmxm$finalModel

tablamxm<-as.data.frame(importance(finalmxm))
tablamxm<-tablamxm[order(-tablamxm$MeanDecreaseAccuracy),]
tablamxm

barplot(tablamxm$MeanDecreaseAccuracy,names.arg=rownames(tablamxm))
dput(rownames(tablamxm))
#mtry = 3




```
The final value used for the model was mtry = 3.



#Data 4 RF importance

seleccion de variable MXM 13 variables 
```{r}

vardep="subtema1"
variables4<-c("targetbinloc1", "targetbin1", "ANONIMO2", "ANONIMO1", "DENUNCIANTE3", 
"DENUNCIANTE2", "INST_DERIVAC2", "MES_INGRESO3", "WEEKDAY_INGRESO1", 
"PARTE_DIA_DERIVAC1", "DENUNCIANTE5")
#hay que quitar las comilla simple 

data4<-data[,c(variables4,vardep)]

```

#Random forest RF importance
```{r }
library(caret)
set.seed(1234) 

rfgridrf<-expand.grid(mtry=c(3,4,5,6,7,8,9,10,11))

controlrf<-trainControl(method = "cv",number=4,savePredictions = "all") 

rfrf<- train( factor(subtema1)~targetbinloc1+ targetbin1+ ANONIMO2+ ANONIMO1+ DENUNCIANTE3+ 
DENUNCIANTE2+ INST_DERIVAC2+ MES_INGRESO3+ WEEKDAY_INGRESO1+ 
PARTE_DIA_DERIVAC1+ DENUNCIANTE5,
            data=data4, method="rf",trControl=controlrf,tuneGrid=rfgridrf, linout = FALSE,ntree=3000,nodesize=20,replace=TRUE, importance=TRUE) 


rfrf

# IMPORTANCIA DE VARIABLES

finalrf<-rfrf$finalModel

tablarf<-as.data.frame(importance(finalrf))
tablarf<-tablarf[order(-tablarf$MeanDecreaseAccuracy),]
tablarf

barplot(tablarf$MeanDecreaseAccuracy,names.arg=rownames(tablarf))
dput(rownames(tablarf))


```

The final value used for the model was mtry = 4.


##*Media 22
```{r}  
medias22<-cruzadarfbin(data=data2, vardep="subtema1",
   listconti=c("ANONIMO2", "targetbinloc1", "DENUNCIANTE2", "targetbin1", 
"DENUNCIANTE6", "MES_INGRESO3", "PARTE_DIA_DERIVAC1", "MES_INGRESO2", 
"MES_INGRESO11", "INST_DERIVAC1", "MES_INGRESO10", "PARTE_DIA_DERIVAC2", 
"MES_INGRESO9", "INST_DERIVAC2", "DENUNCIANTE1", "WEEKDAY_INGRESO4", 
"DENUNCIANTE_EDAD5"),
 listclass=c(""),
  grupos=10,sinicio=1234,repe=25,nodesize=10,
  mtry=9,ntree=3000,replace=TRUE,sampsize=300)

  medias22$modelo="RFstepaic"
  
medias22bis<-as.data.frame(medias22[1]) 
medias22bis$modelo<-"RF" 
predi2<-as.data.frame(medias22[2]) 
predi2$modelo<-"RF"
predi2$RF<-predi2$Yes
```  


##Media 23
```{r}  
medias23<-cruzadarfbin(data=data3, vardep="subtema1",
   listconti=c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2"),
 listclass=c(""),
  grupos=10,sinicio=1234,repe=25,nodesize=20,
  mtry=3,ntree=1500,replace=TRUE,sampsize=800)

  medias23$modelo="RFmxm-3"
  
  
```  
##Media 23.1
```{r}  
medias23.1<-cruzadarfbin(data=data3, vardep="subtema1",
   listconti=c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2"),
 listclass=c(""),
  grupos=10,sinicio=1234,repe=25,nodesize=20,
  mtry=4,ntree=1500,replace=TRUE,sampsize=800)

  medias23.1$modelo="RFmxm-4"
  
  
```  

##Media 24
```{r}  
medias24<-cruzadarfbin(data=data4, vardep="subtema1",
   listconti=c("targetbinloc1", "targetbin1", "ANONIMO2", "ANONIMO1", "DENUNCIANTE3", 
"DENUNCIANTE2", "INST_DERIVAC2", "MES_INGRESO3", "WEEKDAY_INGRESO1", 
"PARTE_DIA_DERIVAC1", "DENUNCIANTE5"),
 listclass=c(""),
  grupos=10,sinicio=1234,repe=25,nodesize=20,
  mtry=3,ntree=1500,replace=TRUE,sampsize=800)

  medias24$modelo="RFRF-3"
  
  
```  

##Media 24.1
```{r}  
medias24.1<-cruzadarfbin(data=data4, vardep="subtema1",
   listconti=c("targetbinloc1", "targetbin1", "ANONIMO2", "ANONIMO1", "DENUNCIANTE3", 
"DENUNCIANTE2", "INST_DERIVAC2", "MES_INGRESO3", "WEEKDAY_INGRESO1", 
"PARTE_DIA_DERIVAC1", "DENUNCIANTE5"),
 listclass=c(""),
  grupos=10,sinicio=1234,repe=25,nodesize=20,
  mtry=4,ntree=1500,replace=TRUE,sampsize=800)

  medias24.1$modelo="RFRF-4"
  
  
```  

#Union5
```{r}


 #Union5<-rbind(medias23,medias23.1)
# Union5<-rbind(medias24,medias24.1)
Union5<-rbind(medias23.1,medias24.1)

dput(names(table(Union5$modelo)))
par(cex.axis=0.8)
boxplot(data=Union5,col="pink",tasa~modelo,main="TASA DE FALLOS")


par(cex.axis=0.7)
boxplot(data=Union5,col="pink",auc~modelo,main="AUC")



```


#Gradient Boosting STEPAIC
```{r}
library(caret)

set.seed(1234)

gbmgrid<-expand.grid(shrinkage=c(0.2,0.1,0.05,0.03,0.01,0.001),
 n.minobsinnode=c(5,10,20),
 n.trees=c(100,500,1000,5000),
 interaction.depth=c(2))

controlgmb<-trainControl(method = "cv",number=4,savePredictions = "all",
 classProbs=TRUE) 

gbmstep<- train(factor(subtema1)~ANONIMO2+ targetbinloc1+ DENUNCIANTE2+ targetbin1+ 
DENUNCIANTE6+ MES_INGRESO3+ PARTE_DIA_DERIVAC1+ MES_INGRESO2+ 
MES_INGRESO11+ INST_DERIVAC1+ MES_INGRESO10+ PARTE_DIA_DERIVAC2+ 
MES_INGRESO9+ INST_DERIVAC2+ DENUNCIANTE1+ WEEKDAY_INGRESO4+ 
DENUNCIANTE_EDAD5,
data=data2,
 method="gbm",trControl=controlgmb,tuneGrid=gbmgrid,
 distribution="bernoulli", bag.fraction=1,verbose=FALSE)#bag fraction no se puede turnear

gbmstep
 
plot(gbmstep)

```

La mejor combinacion con las variables de stepaic es ninosbsinnode=5 , shrinkage= 0.05 y iter = 1000.


#Gradient Boosting MXM
```{r}
library(caret)

set.seed(1234)

gbmgrid<-expand.grid(shrinkage=c(0.2,0.1,0.05,0.03,0.01,0.001),
 n.minobsinnode=c(5,10,20),
 n.trees=c(100,500,1000,5000),
 interaction.depth=c(2))

controlgmb<-trainControl(method = "cv",number=4,savePredictions = "all",
 classProbs=TRUE) 

gbmmxm<- train(factor(subtema1)~targetbin1+ targetbinloc1+ ANONIMO1+ INST_DERIVAC1+ 
DENUNCIANTE2+ DENUNCIANTE3+ MES_INGRESO2+ MES_INGRESO3+ 
PARTE_DIA_DERIVAC1+ PARTE_DIA_DERIVAC2,
data=data3,
 method="gbm",trControl=controlgmb,tuneGrid=gbmgrid,
 distribution="bernoulli", bag.fraction=1,verbose=FALSE)#bag fraction no se puede turnear

gbmmxm
 
plot(gbmmxm)

```
La mejor combinacion con las variables de MXM es ninosbsinnode=5 , shrinkage= 0.05 y iter = 1000.

```{r}
gbmmetr<-expand.grid(shrinkage=c(0.1,0.05,0.03),
 n.minobsinnode=c(5),
 n.trees=c(50,100,300,500,800,1000,1200,1500,2000,2500,3000,3500),
 interaction.depth=c(2))

control<-trainControl(method = "cv",number=4,savePredictions = "all",
 classProbs=TRUE) 

gbmmxmearly<- train(factor(subtema1)~targetbin1+ targetbinloc1+ ANONIMO1+ INST_DERIVAC1+ 
DENUNCIANTE2+ DENUNCIANTE3+ MES_INGRESO2+ MES_INGRESO3+ 
PARTE_DIA_DERIVAC1+ PARTE_DIA_DERIVAC2,data=data3,
 method="gbm",trControl=control,tuneGrid=gbmmetr,
 distribution="bernoulli", bag.fraction=1,verbose=FALSE)




gbmmxmearly
plot(gbmmxmearly)
```



#Data 5 GBM

seleccion de variable MXM 13 variables 
```{r}

vardep="subtema1"
variables5<-c("targetbinloc1", "ANONIMO1", "ANONIMO2", "targetbin1", "DENUNCIANTE2", 
"dias_transcurridos", "PARTE_DIA_DERIVAC1", "INST_DERIVAC1", 
"MES_INGRESO2", "MES_INGRESO3", "DENUNCIANTE3")
#hay que quitar las comilla simple 

data5<-data[,c(variables5,vardep)]

```

#Gradient Boosting GBM
```{r}
library(caret)

set.seed(1234)

gbmgrid<-expand.grid(shrinkage=c(0.2,0.1,0.05,0.03,0.01,0.001),
 n.minobsinnode=c(5,10,20),
 n.trees=c(100,500,1000,5000),
 interaction.depth=c(2))

controlgmb<-trainControl(method = "cv",number=4,savePredictions = "all",
 classProbs=TRUE) 

gbmgbm<- train(factor(subtema1)~targetbinloc1+ ANONIMO1+ ANONIMO2+ targetbin1+ DENUNCIANTE2+ 
dias_transcurridos+ PARTE_DIA_DERIVAC1+ INST_DERIVAC1+ 
MES_INGRESO2+ MES_INGRESO3+ DENUNCIANTE3,
data=data5,
 method="gbm",trControl=controlgmb,tuneGrid=gbmgrid,
 distribution="bernoulli", bag.fraction=1,verbose=FALSE)#bag fraction no se puede turnear

gbmgbm
 
plot(gbmgbm)

```

Tiene dos combinaciones buenas, con las variables de GMB es ninosbsinnode=5 , shrinkage= 0.05 y iter = 1000 y ninosbsinnode=5 , shrinkage= 0.100 y iter = 1000 , ninosbsinnode=5 , shrinkage= 0.010
 y iter =5000



```{r}
gbmmetr<-expand.grid(shrinkage=c(0.1,0.05,0.03),
 n.minobsinnode=c(5),
 n.trees=c(50,100,300,500,800,1000,1200,1500,2000,2500,3000,3500),
 interaction.depth=c(2))

control<-trainControl(method = "cv",number=4,savePredictions = "all",
 classProbs=TRUE) 

gbmgbmearly<- train(factor(subtema1)~targetbinloc1+ ANONIMO1+ ANONIMO2+ targetbin1+ DENUNCIANTE2+ 
dias_transcurridos+ PARTE_DIA_DERIVAC1+ INST_DERIVAC1+ 
MES_INGRESO2+ MES_INGRESO3+ DENUNCIANTE3,
data=data5,
 method="gbm",trControl=controlgmb,tuneGrid=gbmmetr,
 distribution="bernoulli", bag.fraction=1,verbose=FALSE)



gbmgbmearly
plot(gbmgbmearly)
```


##*Media 25
```{r}  
source ("cruzada gbm binaria.R")

medias25<-cruzadagbmbin(data=data2, vardep="subtema1",
   listconti=c("ANONIMO2", "targetbinloc1", "DENUNCIANTE2", "targetbin1", 
"DENUNCIANTE6", "MES_INGRESO3", "PARTE_DIA_DERIVAC1", "MES_INGRESO2", 
"MES_INGRESO11", "INST_DERIVAC1", "MES_INGRESO10", "PARTE_DIA_DERIVAC2", 
"MES_INGRESO9", "INST_DERIVAC2", "DENUNCIANTE1", "WEEKDAY_INGRESO4", 
"DENUNCIANTE_EDAD5"),
 listclass=c(""),
 grupos=4,sinicio=1234,repe=25,
n.minobsinnode=5,shrinkage=0.05,n.trees=1000,interaction.depth=2)


medias25<-cruzadagbmbin(data=data3, vardep="subtema1",
   listconti=c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2"),
 listclass=c(""),
  grupos=4,sinicio=1234,repe=25,
n.minobsinnode=5,shrinkage=0.03,n.trees=1500,interaction.depth=2)

  medias25$modelo="GBmxm0,03"


```  

##Media 26
```{r}  
medias26<-cruzadagbmbin(data=data3, vardep="subtema1",
   listconti=c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2"),
 listclass=c(""),
  grupos=4,sinicio=1234,repe=25,
n.minobsinnode=5,shrinkage=0.05,n.trees=1500 ,interaction.depth=2)

  medias26$modelo="GBmxm0,05"

  
```  

##Media 27
```{r}  
medias27<-cruzadagbmbin(data=data5, vardep="subtema1",
   listconti=c("targetbinloc1", "ANONIMO1", "ANONIMO2", "targetbin1", "DENUNCIANTE2", 
"dias_transcurridos", "PARTE_DIA_DERIVAC1", "INST_DERIVAC1", 
"MES_INGRESO2", "MES_INGRESO3", "DENUNCIANTE3"),
 listclass=c(""),
  grupos=4,sinicio=1234,repe=25,
n.minobsinnode=5,shrinkage=0.05,n.trees=1000,interaction.depth=2)

  medias27$modelo="GBMGBM1"

  
```  


##Media 28
```{r}  
medias28<-cruzadagbmbin(data=data5, vardep="subtema1",
   listconti=c("targetbinloc1", "ANONIMO1", "ANONIMO2", "targetbin1", "DENUNCIANTE2", 
"dias_transcurridos", "PARTE_DIA_DERIVAC1", "INST_DERIVAC1", 
"MES_INGRESO2", "MES_INGRESO3", "DENUNCIANTE3"),
 listclass=c(""),
  grupos=4,sinicio=1234,repe=25,
n.minobsinnode=5,shrinkage=0.1,n.trees=500,interaction.depth=2)

  medias28$modelo="GBMGBM2"
  
  
```  


##Media 29
```{r}  
medias29<-cruzadagbmbin(data=data3, vardep="subtema1",
   listconti=c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2"),
 listclass=c(""),
  grupos=4,sinicio=1234,repe=25,
n.minobsinnode=5,shrinkage=0.05,n.trees=1000 ,interaction.depth=2)

  medias29$modelo="GBmxm1000"
  
```  


#Union6
```{r}
Union6<-rbind(medias25,medias26,medias29)

dput(names(table(Union6$modelo)))
par(cex.axis=0.8)
boxplot(data=Union6,col="pink",tasa~modelo,main="TASA DE FALLOS")


par(cex.axis=0.7)
boxplot(data=Union6,col="pink",auc~modelo,main="AUC")



```


#Union7
```{r}
Union7<-rbind(medias25,medias28)

dput(names(table(Union7$modelo)))
par(cex.axis=0.8)
boxplot(data=Union7,col="pink",tasa~modelo,main="TASA DE FALLOS")


par(cex.axis=0.7)
boxplot(data=Union7,col="pink",auc~modelo,main="AUC")



```
#Xboost stepaic
```{r}

source ("cruzada xgboost binaria.R")
xgbmgrid<-expand.grid(
 min_child_weight=c(5,10,20),
 eta=c(0.1,0.05,0.03,0.01,0.001),
 nrounds=c(100,500,1000,5000),
 max_depth=6,gamma=0,colsample_bytree=1,subsample=1)

control<-trainControl(method = "cv",number=4,savePredictions = "all",
 classProbs=TRUE) 

xgbmstepaic<- train(factor(subtema1)~ANONIMO2+ targetbinloc1+ DENUNCIANTE2+ targetbin1+ 
DENUNCIANTE6+ MES_INGRESO3+ PARTE_DIA_DERIVAC1+ MES_INGRESO2+ 
MES_INGRESO11+ INST_DERIVAC1+ MES_INGRESO10+ PARTE_DIA_DERIVAC2+ 
MES_INGRESO9+ INST_DERIVAC2+ DENUNCIANTE1+ WEEKDAY_INGRESO4+ 
DENUNCIANTE_EDAD5,
 data=data2,
 method="xgbTree",trControl=control,
 tuneGrid=xgbmgrid,verbose=FALSE)

xgbmstepaic
 
plot(xgbmstepaic)

```
The final values used for the model were nrounds = 1000, max_depth = 6, eta = 0.03, gamma =
 0, colsample_bytree = 1, min_child_weight = 10 and subsample = 1.


#Xboost mxm
```{r}

source ("cruzada xgboost binaria.R")
xgbmgrid<-expand.grid(
 min_child_weight=c(5,10,20),
 eta=c(0.1,0.05,0.03,0.01,0.001),
 nrounds=c(100,500,1000,5000),
 max_depth=6,gamma=0,colsample_bytree=1,subsample=1)

control<-trainControl(method = "cv",number=4,savePredictions = "all",
 classProbs=TRUE) 

xgbmmxm<- train(factor(subtema1)~targetbin1+ targetbinloc1+ ANONIMO1+ INST_DERIVAC1+ 
DENUNCIANTE2+ DENUNCIANTE3+ MES_INGRESO2+ MES_INGRESO3+ 
PARTE_DIA_DERIVAC1+ PARTE_DIA_DERIVAC2,
 data=data3,
 method="xgbTree",trControl=control,
 tuneGrid=xgbmgrid,verbose=FALSE)

xgbmmxm
 
plot(xgbmmxm)

```

The final values used for the model were nrounds = 500, max_depth = 6, eta = 0.01, gamma =
 0, colsample_bytree = 1, min_child_weight = 10 and subsample = 1.


```{r}
xgbmgrid<-expand.grid(eta=c(0.03,0.01,0.05),
 min_child_weight=c(10),
 nrounds=c(50,100,300,500,800,1000,1200,1500,2000),
  max_depth=6,gamma=0,colsample_bytree=1,subsample=1)

set.seed(1234)
control<-trainControl(method = "cv",number=4,savePredictions = "all",
 classProbs=TRUE) 

xgbmmxmearly<- train(factor(subtema1)~targetbin1+ targetbinloc1+ ANONIMO1+ INST_DERIVAC1+ 
DENUNCIANTE2+ DENUNCIANTE3+ MES_INGRESO2+ MES_INGRESO3+ 
PARTE_DIA_DERIVAC1+ PARTE_DIA_DERIVAC2,
 data=data3,
 method="xgbTree",trControl=control,
 tuneGrid=xgbmgrid,verbose=FALSE)



plot(xgbmmxmearly)
```





#Xboost gbm
```{r}

source ("cruzada xgboost binaria.R")
xgbmgrid<-expand.grid(
 min_child_weight=c(5,10,20),
 eta=c(0.1,0.05,0.03,0.01,0.001),
 nrounds=c(100,500,1000,5000),
 max_depth=6,gamma=0,colsample_bytree=1,subsample=1)

control<-trainControl(method = "cv",number=4,savePredictions = "all",
 classProbs=TRUE) 

xgbmgbm<- train(factor(subtema1)~targetbinloc1+ ANONIMO1+ ANONIMO2+ targetbin1+ DENUNCIANTE2+ 
dias_transcurridos+ PARTE_DIA_DERIVAC1+ INST_DERIVAC1+ 
MES_INGRESO2+ MES_INGRESO3+ DENUNCIANTE3,
 data=data5,
 method="xgbTree",trControl=control,
 tuneGrid=xgbmgrid,verbose=FALSE)

xgbmgbm
 
plot(xgbmgbm)

```
The final values used for the model were nrounds = 5000, max_depth = 6, eta = 0.001, gamma =
 0, colsample_bytree = 1, min_child_weight = 10 and subsample = 1.
 
 
##Media 30
```{r}  

source ("cruzada xgboost binaria.R")

medias30<-cruzadaxgbmbin(data=data2, vardep="subtema1",
   listconti=c("ANONIMO2", "targetbinloc1", "DENUNCIANTE2", "targetbin1", 
"DENUNCIANTE6", "MES_INGRESO3", "PARTE_DIA_DERIVAC1", "MES_INGRESO2", 
"MES_INGRESO11", "INST_DERIVAC1", "MES_INGRESO10", "PARTE_DIA_DERIVAC2", 
"MES_INGRESO9", "INST_DERIVAC2", "DENUNCIANTE1", "WEEKDAY_INGRESO4", 
"DENUNCIANTE_EDAD5"),
 listclass=c(""),
 grupos=4,sinicio=1234,repe=25,
   min_child_weight=10,eta=0.03,nrounds=1000,max_depth=6,
  gamma=0,colsample_bytree=1,subsample=1,
 alpha=0,lambda=0)

  medias30$modelo="XBOOSTstepaic"

  
  medias30<-cruzadaxgbmbin(data=data3, vardep="subtema1",
   listconti=c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2"),
 listclass=c(""),
  grupos=4,sinicio=1234,repe=25,
   min_child_weight=10,eta=0.01,nrounds=500,max_depth=6,
  gamma=0,colsample_bytree=1,subsample=1,
 alpha=0,lambda=0)

  medias30$modelo="XBoostmxm0,01-500"
  
```  
 


##*Media 31
```{r}  

source ("cruzada xgboost binaria.R")
medias31<-cruzadaxgbmbin(data=data3, vardep="subtema1",
   listconti=c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2"),
 listclass=c(""),
  grupos=4,sinicio=1234,repe=25,
   min_child_weight=10,eta=0.01,nrounds=800,max_depth=6,
  gamma=0,colsample_bytree=1,subsample=1,
 alpha=0,lambda=0)

  medias31$modelo="XBoostmxm0,01"



```



##Media 32
```{r}  
medias32<-cruzadaxgbmbin(data=data3, vardep="subtema1",
   listconti=c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2"),
 listclass=c(""),
  grupos=4,sinicio=1234,repe=25,
   min_child_weight=10,eta=0.05,nrounds=100,max_depth=6,
  gamma=0,colsample_bytree=1,subsample=1,
 alpha=0,lambda=0)

  medias32$modelo="XBoostmxm0,05"

  
```  




#Union8
```{r}
Union8<-rbind(medias31,medias32,medias30)

dput(names(table(Union8$modelo)))
par(cex.axis=0.8)
boxplot(data=Union8,col="pink",tasa~modelo,main="TASA DE FALLOS")


par(cex.axis=0.7)
boxplot(data=Union8,col="pink",auc~modelo,main="AUC")



```


#Union9
```{r}
Union9<-rbind(medias31,medias32)

dput(names(table(Union9$modelo)))
par(cex.axis=0.8)
boxplot(data=Union9,col="pink",tasa~modelo,main="TASA DE FALLOS")


par(cex.axis=0.7)
boxplot(data=Union9,col="pink",auc~modelo,main="AUC")



```


#Uniontodo10
```{r}
Union10<-rbind(medias3,medias11,medias21,medias22,medias25,medias26,medias31)

dput(names(table(Union10$modelo)))
par(cex.axis=0.8)
boxplot(data=Union10,col="pink",tasa~modelo,main="TASA DE FALLOS")


par(cex.axis=0.7)
boxplot(data=Union10,col="pink",auc~modelo,main="AUC")



```

#SVM lineal STEPAIC

```{r}
set.seed(1234)
SVMgrid<-expand.grid(C=c(0.01,0.05,0.1,0.2,0.5,1,2,5,10))

control<-trainControl(method = "cv",number=4,savePredictions = "all") 

SVMstep<- train(data=data2,factor(subtema1)~ANONIMO2+ targetbinloc1+ DENUNCIANTE2+ targetbin1+ 
DENUNCIANTE6+ MES_INGRESO3+ PARTE_DIA_DERIVAC1+ MES_INGRESO2+ 
MES_INGRESO11+ INST_DERIVAC1+ MES_INGRESO10+ PARTE_DIA_DERIVAC2+ 
MES_INGRESO9+ INST_DERIVAC2+ DENUNCIANTE1+ WEEKDAY_INGRESO4+ 
DENUNCIANTE_EDAD5,
            method="svmLinear",trControl=control,
            tuneGrid=SVMgrid,verbose=FALSE)

SVMstep$results
plot(SVMstep$results$C,SVMstep$results$Accuracy)


# Rehago el grid para observar mejor el intervalo de C entre 0 y 0.6
SVMgrid<-expand.grid(C=c(0.01,0.02,0.03,0.04,0.05,0.8,0.1,0.2,0.3,0.4,0.5,0.6))

control<-trainControl(method = "cv",number=4,savePredictions = "all") 

SVMstep<- train(data=data2,factor(subtema1)~ANONIMO2+ targetbinloc1+ DENUNCIANTE2+ targetbin1+ 
DENUNCIANTE6+ MES_INGRESO3+ PARTE_DIA_DERIVAC1+ MES_INGRESO2+ 
MES_INGRESO11+ INST_DERIVAC1+ MES_INGRESO10+ PARTE_DIA_DERIVAC2+ 
MES_INGRESO9+ INST_DERIVAC2+ DENUNCIANTE1+ WEEKDAY_INGRESO4+ 
DENUNCIANTE_EDAD5,
            method="svmLinear",trControl=control,
            tuneGrid=SVMgrid,verbose=FALSE)

SVMstep$results
plot(SVMstep$results$C,SVMstep$results$Accuracy)

#c=0.2

datSVMstep<-as.data.frame(SVMstep$results)
library(ggplot2)

# PLOT DE DOS VARIABLES CATEGÓRICAS, UNA CONTINUA
ggplot(datSVMstep, aes(x=factor(C), y=Accuracy, 
                color=factor(degree),pch=factor(scale))) +
  geom_point(position=position_dodge(width=0.5),size=3)
```


#SVM lineal MXM
```{r}
set.seed(1234)
SVMgrid<-expand.grid(C=c(0.01,0.05,0.1,0.2,0.5,1,2,5,10))

control<-trainControl(method = "cv",number=4,savePredictions = "all") 

SVMMXM<- train(data=data3,factor(subtema1)~targetbin1+ targetbinloc1+ ANONIMO1+ INST_DERIVAC1+ 
DENUNCIANTE2+ DENUNCIANTE3+ MES_INGRESO2+ MES_INGRESO3+ 
PARTE_DIA_DERIVAC1+ PARTE_DIA_DERIVAC2,
            method="svmLinear",trControl=control,
            tuneGrid=SVMgrid,verbose=FALSE)

SVMMXM$results
plot(SVMMXM$results$C,SVMMXM$results$Accuracy)


# Rehago el grid para observar mejor el intervalo de C entre 0 y 0.6
SVMgrid<-expand.grid(C=c(0.01,0.02,0.03,0.04,0.05,0.8,0.1,0.2,0.3,0.4,0.5,0.6))

control<-trainControl(method = "cv",number=4,savePredictions = "all") 

SVMMXM<- train(data=data3,factor(subtema1)~targetbin1+ targetbinloc1+ ANONIMO1+ INST_DERIVAC1+ 
DENUNCIANTE2+ DENUNCIANTE3+ MES_INGRESO2+ MES_INGRESO3+ 
PARTE_DIA_DERIVAC1+ PARTE_DIA_DERIVAC2,
            method="svmLinear",trControl=control,
            tuneGrid=SVMgrid,verbose=FALSE)


SVMMXM$results
plot(SVMMXM$results$C,SVMMXM$results$Accuracy)


```


#SVM polinomial stepaic


```{r}
SVMgrid<-expand.grid(C=c(0.01,0.05,0.1,0.2,0.5,1,2,5,10),
                     degree=c(2,3),scale=c(0.1,0.5,1,2,5))

control<-trainControl(method = "cv",
                      number=4,savePredictions = "all") 


SVMSTEPPOLI<- train(data=data2,factor(subtema1)~ANONIMO2+ targetbinloc1+ DENUNCIANTE2+ targetbin1+ 
DENUNCIANTE6+ MES_INGRESO3+ PARTE_DIA_DERIVAC1+ MES_INGRESO2+ 
MES_INGRESO11+ INST_DERIVAC1+ MES_INGRESO10+ PARTE_DIA_DERIVAC2+ 
MES_INGRESO9+ INST_DERIVAC2+ DENUNCIANTE1+ WEEKDAY_INGRESO4+ 
DENUNCIANTE_EDAD5,
            method="svmPoly",trControl=control,
            tuneGrid=SVMgrid,verbose=FALSE)

SVMSTEPPOLI

SVMSTEPPOLI$results

datSVMstepPOLI<-as.data.frame(SVMSTEPPOLI$results)
library(ggplot2)

# PLOT DE DOS VARIABLES CATEGÓRICAS, UNA CONTINUA
ggplot(datSVMstepPOLI, aes(x=factor(C), y=Accuracy,
                color=factor(degree),pch=factor(scale))) +
  geom_point(position=position_dodge(width=0.5),size=3)

```

degree = 2, scale = 0.5 and C = 1.




#SVM polinomial mxm
```{r}
SVMgrid<-expand.grid(C=c(0.01,0.05,0.1,0.2,0.5,1,2,5,10),
                     degree=c(2,3),scale=c(0.1,0.5,1,2,5))

control<-trainControl(method = "cv",
                      number=4,savePredictions = "all") 


SVMMXMPOLI<- train(data=data3,factor(subtema1)~targetbin1+ targetbinloc1+ ANONIMO1+ INST_DERIVAC1+ 
DENUNCIANTE2+ DENUNCIANTE3+ MES_INGRESO2+ MES_INGRESO3+ 
PARTE_DIA_DERIVAC1+ PARTE_DIA_DERIVAC2,
            method="svmPoly",trControl=control,
            tuneGrid=SVMgrid,verbose=FALSE)

SVMMXMPOLI

SVMMXMPOLI$results

datSVMMXMPOLI<-as.data.frame(SVMMXMPOLI$results)
library(ggplot2)

# PLOT DE DOS VARIABLES CATEGÓRICAS, UNA CONTINUA
ggplot(datSVMMXMPOLI, aes(x=factor(C), y=Accuracy,
                color=factor(degree),pch=factor(scale))) +
  geom_point(position=position_dodge(width=0.5),size=3)



# SOLO DEGREE=2
datSVMMXMPOLI2<-datSVMMXMPOLI[datSVMMXMPOLI$degree==2,]  

ggplot(datSVMMXMPOLI2, aes(x=factor(C), y=Accuracy, 
                 colour=factor(scale))) +
  geom_point(position=position_dodge(width=0.5),size=3)

```

degree = 2, scale = 1 and C = 0.1

#SVM RBF atepaic
```{r}
SVMgrid<-expand.grid(C=c(0.5,1,2,5,10,30),
                     sigma=c(0.0001,0.005,0.01,0.05))

control<-trainControl(method = "cv",
                      number=4,savePredictions = "all") 


SVMstepRBF<- train(data=data2,factor(subtema1)~ANONIMO2+ targetbinloc1+ DENUNCIANTE2+ targetbin1+ 
DENUNCIANTE6+ MES_INGRESO3+ PARTE_DIA_DERIVAC1+ MES_INGRESO2+ 
MES_INGRESO11+ INST_DERIVAC1+ MES_INGRESO10+ PARTE_DIA_DERIVAC2+ 
MES_INGRESO9+ INST_DERIVAC2+ DENUNCIANTE1+ WEEKDAY_INGRESO4+ 
DENUNCIANTE_EDAD5,
            method="svmRadial",trControl=control,
            tuneGrid=SVMgrid,verbose=FALSE)

SVMstepRBF

SVMstepRBF1<-as.data.frame(SVMstepRBF$results)

ggplot(SVMstepRBF1, aes(x=factor(C), y=Accuracy, 
                color=factor(sigma)))+ 
  geom_point(position=position_dodge(width=0.5),size=3)
```
  
sigma = 0.01 and C = 10



#SVM RBF MXM
```{r}
SVMgrid<-expand.grid(C=c(0.5,1,2,5,10,30),
                     sigma=c(0.0001,0.005,0.01,0.05))

control<-trainControl(method = "cv",
                      number=4,savePredictions = "all") 


SVMMXMRBF<- train(data=data3,factor(subtema1)~targetbin1+ targetbinloc1+ ANONIMO1+ INST_DERIVAC1+ 
DENUNCIANTE2+ DENUNCIANTE3+ MES_INGRESO2+ MES_INGRESO3+ 
PARTE_DIA_DERIVAC1+ PARTE_DIA_DERIVAC2,
            method="svmRadial",trControl=control,
            tuneGrid=SVMgrid,verbose=FALSE)

SVMMXMRBF

SVMMXMRBF1<-as.data.frame(SVMMXMRBF$results)

ggplot(SVMMXMRBF1, aes(x=factor(C), y=Accuracy, 
                color=factor(sigma)))+ 
  geom_point(position=position_dodge(width=0.5),size=3)
```
sigma = 0.05 and C = 5

##Media 33
```{r}  

source ("cruzada SVM binaria lineal.R")
source ("cruzada SVM binaria polinomial.R")
source ("cruzada SVM binaria RBF.R")

medias33<-cruzadaSVMbin(data=data2, vardep="subtema1",
   listconti=c("ANONIMO2", "targetbinloc1", "DENUNCIANTE2", "targetbin1", 
"DENUNCIANTE6", "MES_INGRESO3", "PARTE_DIA_DERIVAC1", "MES_INGRESO2", 
"MES_INGRESO11", "INST_DERIVAC1", "MES_INGRESO10", "PARTE_DIA_DERIVAC2", 
"MES_INGRESO9", "INST_DERIVAC2", "DENUNCIANTE1", "WEEKDAY_INGRESO4", 
"DENUNCIANTE_EDAD5"),
                       listclass=c(""),
                       grupos=4,sinicio=1234,repe=25,C=0.2)

  medias33$modelo="SVMsteplineal"

  

  
```  

##Media 34
```{r}  
medias34<-cruzadaSVMbin(data=data3, vardep="subtema1",
   listconti=c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2"),
listclass=c(""),
                       grupos=4,sinicio=1234,repe=25,C=0.1)

  medias34$modelo="SVMMXMlineal"

  
```  

##Media 35
```{r}  
medias35<-cruzadaSVMbinPoly(data=data3, vardep="subtema1",
   listconti=c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2"),
listclass=c(""),
                           grupos=4,sinicio=1234,repe=25,
                           C=1,degree=2,scale=0.5)

  medias35$modelo="SVMPolystep"


```  

##Media 36
```{r}  
medias36<-cruzadaSVMbinPoly(data=data2, vardep="subtema1",
   listconti=c("ANONIMO2", "targetbinloc1", "DENUNCIANTE2", "targetbin1", 
"DENUNCIANTE6", "MES_INGRESO3", "PARTE_DIA_DERIVAC1", "MES_INGRESO2", 
"MES_INGRESO11", "INST_DERIVAC1", "MES_INGRESO10", "PARTE_DIA_DERIVAC2", 
"MES_INGRESO9", "INST_DERIVAC2", "DENUNCIANTE1", "WEEKDAY_INGRESO4", 
"DENUNCIANTE_EDAD5"),
listclass=c(""),
                           grupos=4,sinicio=1234,repe=25,
                           C=0.1,degree=2,scale=1)

  medias36$modelo="SVMPolyMXM"

  
```  

##Media 37
```{r}  
medias37<-cruzadaSVMbinRBF(data=data3, vardep="subtema1",
   listconti=c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2"),
                           listclass=c(""),
                           grupos=4,sinicio=1234,repe=25,
                           C=2,sigma=0.05)

  medias37$modelo="SVMRBFMXM2-0.05"
  


  
```  

##Media 38
```{r}  
medias38<-cruzadaSVMbinRBF(data=data3, vardep="subtema1",
   listconti=c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2"),
                           listclass=c(""),
                           grupos=4,sinicio=1234,repe=25,
                           C=5,sigma=0.05)

  medias38$modelo="SVMRBFMXM5-0.05"
  

  
```  
#Union11
```{r}
Union11<-rbind(medias34,medias36,medias37,medias38)

dput(names(table(Union11$modelo)))
par(cex.axis=0.8)
boxplot(data=Union11,col="pink",tasa~modelo,main="TASA DE FALLOS")


par(cex.axis=0.7)
boxplot(data=Union11,col="pink",auc~modelo,main="AUC")



```

El mejor es SVMRBFMXM


Unimos ahora de todos los modelos.


#Uniontodo12
```{r}
Union12<-rbind(medias3,medias11,medias21,medias22,medias25,medias26,medias31,medias38)

dput(names(table(Union12$modelo)))
par(cex.axis=0.5)
boxplot(data=Union12,col="pink",tasa~modelo,main="TASA DE FALLOS")


par(cex.axis=0.5)
boxplot(data=Union12,col="pink",auc~modelo,main="AUC")



```


El mejor modelo sigue siendo el de gradient boosting con la combinacion de STEPAIC 







#Ensamblado

Quiero hacer ensamblado de los modelos los cuales han tenido buenos resultados. Son: Gradient boosting, Xboost, Bagging y por ultimo random forest. 

##Modelos
```{r}

source("cruzadas ensamblado binaria fuente.R")


archivo<-TRATAbis

vardep<-"subtema1"

listcontiMXM=c("targetbin1", "targetbinloc1", "ANONIMO1", "INST_DERIVAC1", 
"DENUNCIANTE2", "DENUNCIANTE3", "MES_INGRESO2", "MES_INGRESO3", 
"PARTE_DIA_DERIVAC1", "PARTE_DIA_DERIVAC2")
listclass<-c("")
grupos<-4
sinicio<-1234
repe<-50

c("baggingMXM300", "GBstepaic", "Red con maxit1", "RFstepaic", 
"STEPrep1.AIC", "SVMRBFMXM", "XBoostmxm")

medias39<-cruzadalogistica(data=archivo,
                          vardep=vardep,listconti=listcontiMXM,
                          listclass=listclass,grupos=grupos,sinicio=sinicio,repe=repe)

medias39bis<-as.data.frame(medias39[1])
medias39bis$modelo<-"Logistica"
predi5<-as.data.frame(medias39[2])
predi5$logi<-predi5$Yes



medias40<-cruzadaavnnetbin(data=archivo,
                          vardep=vardep,listconti=listcontiMXM,
                          listclass=listclass,grupos=grupos,sinicio=sinicio,repe=repe,
                          size=c(4),decay=c(0.0001),repeticiones=5,itera=1000)

medias40bis<-as.data.frame(medias40[1])
medias40bis$modelo<-"avnnet"
predi6<-as.data.frame(medias40[2])
predi6$avnnet<-predi6$Yes


medias41<-cruzadarfbin(data=archivo,
                      vardep=vardep,listconti=listcontiMXM,
                      listclass=listclass,grupos=grupos,sinicio=sinicio,repe=repe,
                      mtry=4,ntree=1500,nodesize=20,replace=TRUE,sampsize=800)



medias41bis<-as.data.frame(medias41[1])
medias41bis$modelo<-"rf"
predi7<-as.data.frame(medias41[2])
predi7$rf<-predi7$Yes

medias42<-cruzadagbmbin(data=archivo,
                       vardep=vardep,listconti=listcontiMXM,
                       listclass=listclass,grupos=grupos,sinicio=sinicio,repe=repe,
                       n.minobsinnode=5,shrinkage=0.03,n.trees=1500,interaction.depth=2)

medias42bis<-as.data.frame(medias42[1])
medias42bis$modelo<-"gbm"
predi8<-as.data.frame(medias42[2])
predi8$gbm<-predi8$Yes



medias43<-cruzadaxgbmbin(data=archivo,
                        vardep=vardep,listconti=listcontiMXM,
                        listclass=listclass,grupos=grupos,sinicio=sinicio,repe=repe,
                        min_child_weight=10,eta=0.01,nrounds=800,max_depth=6,
                        gamma=0,colsample_bytree=1,subsample=1,
                        alpha=0,lambda=0)


medias43bis<-as.data.frame(medias43[1])
medias43bis$modelo<-"xgbm"
predi9<-as.data.frame(medias43[2])
predi9$xgbm<-predi9$Yes


medias44<-cruzadaSVMbinRBF(data=archivo,
                          vardep=vardep,listconti=listcontiMXM,
                          listclass=listclass,grupos=grupos,
                          sinicio=sinicio,repe=repe,
                          C=5,sigma=0.05)

medias44bis<-as.data.frame(medias44[1])
medias44bis$modelo<-"svmRadial"
predi10<-as.data.frame(medias44[2])
predi10$svmRadial<-predi10$Yes


medias46<-cruzadagbmbin(data=archivo,
                       vardep=vardep,listconti=listcontiMXM,
                       listclass=listclass,grupos=grupos,sinicio=sinicio,repe=repe,
                       n.minobsinnode=5,shrinkage=0.05,n.trees=1000,interaction.depth=2)

medias46bis<-as.data.frame(medias46[1])
medias46bis$modelo<-"gbmmxm"
predi8.1<-as.data.frame(medias46[2])
predi8.1$gbmmxm<-predi8.1$Yes




```


##Union 13
```{r}
medias39bis<-as.data.frame(medias39[1])
medias39bis$modelo<-"Logistica"
predi5<-as.data.frame(medias39[2])
predi5$logi<-predi5$Yes


medias40bis<-as.data.frame(medias40[1])
medias40bis$modelo<-"avnnet"
predi6<-as.data.frame(medias40[2])
predi6$avnnet<-predi6$Yes

medias41bis<-as.data.frame(medias41[1])
medias41bis$modelo<-"rf"
predi7<-as.data.frame(medias41[2])
predi7$rf<-predi7$Yes


medias42bis<-as.data.frame(medias42[1])
medias42bis$modelo<-"gbm"
predi8<-as.data.frame(medias42[2])
predi8$gbm<-predi8$Yes



medias43bis<-as.data.frame(medias43[1])
medias43bis$modelo<-"xgbm"
predi9<-as.data.frame(medias43[2])
predi9$xgbm<-predi9$Yes


medias44bis<-as.data.frame(medias44[1])
medias44bis$modelo<-"svmRadial"
predi10<-as.data.frame(medias44[2])
predi10$svmRadial<-predi10$Yes

medias46bis<-as.data.frame(medias46[1])
medias46bis$modelo<-"gbmmxm"
predi8.1<-as.data.frame(medias46[2])
predi8.1$gbmmxm<-predi8.1$Yes


modelopred19.2 <- subset(medias45, modelo == "predi19.2", select = c(auc, tasa,modelo))

union13<-rbind(medias39bis,medias40bis,
              medias41bis,medias43bis,medias44bis,medias46bis,mediaslog,medias34,medias36,modelopred19.2)

par(cex.axis=0.8)
boxplot(data=union13,tasa~modelo,col="pink",main='TASA FALLOS')
boxplot(data=union13,auc~modelo,col="pink",main='AUC')


union13$modelo <- with(union13,
                       reorder(modelo,auc, mean))

# CONSTRUCCIÓN DE TODOS LOS ENSAMBLADOS
# SE UTILIZARÁN LOS ARCHIVOS SURGIDOS DE LAS FUNCIONES LLAMADOS predi1,...

unipredi<-cbind(predi5,predi6,predi7,predi8,predi9,predi10,predi8.1)

# Esto es para eliminar columnas duplicadas
unipredi<- unipredi[, !duplicated(colnames(unipredi))]




```




##Construir ensamblado
```{r}

#Dado que logistica y svm no son buenos, no se hara ensamblado de estos dos 



source("cruzadas ensamblado binaria fuente.R")

unipredi$predi11<-(unipredi$avnnet+unipredi$rf)/2
unipredi$predi12<-(unipredi$avnnet+unipredi$gbm)/2
unipredi$predi13<-(unipredi$avnnet+unipredi$xgbm)/2
unipredi$predi13mxm<-(unipredi$avnnet+unipredi$gbmmxm)/2

unipredi$predi14<-(unipredi$rf+unipredi$gbm)/2
unipredi$predi15<-(unipredi$rf+unipredi$xgbm)/2
unipredi$predi15.1<-(unipredi$rf+unipredi$gbmmxm)/2
unipredi$predi16<-(unipredi$gbm+unipredi$xgbm)/2
unipredi$predi16.1<-(unipredi$gbm+unipredi$gbmmxm)/2
unipredi$predi16.2<-(unipredi$xgbm+unipredi$gbmmxm)/2



unipredi$predi17<-(unipredi$avnnet+unipredi$rf+unipredi$gbm)/3
unipredi$predi18<-(unipredi$avnnet+unipredi$rf+unipredi$xgbm)/3
unipredi$predi18.1<-(unipredi$avnnet+unipredi$rf+unipredi$gbmmxm)/3
unipredi$predi19<-(unipredi$rf+unipredi$gbm+unipredi$xgbm)/3
unipredi$predi19.1<-(unipredi$rf+unipredi$gbm+unipredi$gbmmxm)/3
unipredi$predi19.2<-(unipredi$xgbm+unipredi$gbm+unipredi$gbmmxm)/3

unipredi$predi20<-(unipredi$avnnet+unipredi$rf+unipredi$gbm+unipredi$xgbm)/4
unipredi$predi20.1<-(unipredi$avnnet+unipredi$rf+unipredi$gbm+unipredi$gbmmxm)/4
unipredi$predi20.2<-(unipredi$xgbm+unipredi$rf+unipredi$gbm+unipredi$gbmmxm)/4


unipredi$predi21<-(unipredi$avnnet+unipredi$rf+unipredi$gbm+unipredi$xgbm+unipredi$gbmmxm)/5

# Listado de modelos a considerar, cambiar al gusto

dput(names(unipredi))



listado<-c( "avnnet", "rf", "gbm", "xgbm","gbmmxm", "predi13mxm", "predi14", "predi15", "predi15.1", "predi16", 
"predi16.1", "predi16.2", "predi17", "predi18", "predi18.1", 
"predi19", "predi19.1", "predi19.2", "predi20", "predi20.1", 
"predi20.2", "predi21", "predi11", "predi12", "predi13")
```


## Tasa fallos
```{r}

# Cambio a Yes, No, todas las predicciones

# for (prediccion in listado) 
#   { unipredi[,prediccion]<-ifelse(unipredi[,prediccion]>0.5,"Yes","No") }

# Defino funcion tasafallos 

tasafallos<-function(x,y) { 
  confu<-confusionMatrix(x,y) 
tasa<-confu[[3]][1] 
return(tasa) } 


auc<-function(x,y) { 
  curvaroc<-roc(response=x,predictor=y) 
  auc<-curvaroc$auc 
  return(auc) 
  }

# Se obtiene el numero de repeticiones CV y se calculan las medias por repe en # el data frame medias0 



repeticiones<-nlevels(factor(unipredi$Rep))
unipredi$Rep<-as.factor(unipredi$Rep)
unipredi$Rep<-as.numeric(unipredi$Rep)


medias45<-data.frame(c())
for (prediccion in listado)
{
  unipredi$proba<-unipredi[,prediccion]
  unipredi[,prediccion]<-ifelse(unipredi[,prediccion]>0.5,"Yes","No")
  for (repe in 1:repeticiones)
  {
    paso <- unipredi[(unipredi$Rep==repe),]
    pre<-factor(paso[,prediccion])
    archi<-paso[,c("proba","obs")]
    archi<-archi[order(archi$proba),]
    obs<-paso[,c("obs")]
    tasa=1-tasafallos(pre,obs)
    t<-as.data.frame(tasa)
    t$modelo<-prediccion
    auc<-suppressMessages(auc(archi$obs,archi$proba))
    t$auc<-auc
    medias45<-rbind(medias45,t)
  }
}


# medias45<-data.frame(c()) 
# for (prediccion in listado) 
#   { for (repe in 1:repeticiones) 
#     { 
#     paso <- unipredi[(unipredi$Rep==repe),] 
#     pre<-factor(paso[,prediccion]) 
#     obs<-paso[,c("obs")] 
#     tasa=1-tasafallos(pre,obs) 
#     t<-as.data.frame(tasa) 
#     t$modelo<-prediccion
#     auc<-suppressMessages(auc(archi$obs,archi$proba))
#     t$auc<-auc
# medias45<-rbind(medias45,t) } }




# Finalmente boxplot
par(cex.axis=0.5,las=2)
boxplot(data=medias45,tasa~modelo,col="pink",main="TASA FALLOS")



# PRESENTACION TABLA MEDIAS 

tablamedias<-medias45 %>% group_by(modelo) %>% summarize(tasa=mean(tasa))
tablamedias<-as.data.frame(tablamedias[order(tablamedias$tasa),])


# ORDENACIÓN DEL FACTOR MODELO POR LAS MEDIAS EN TASA # PARA EL GRAFICO
medias45$modelo <- with(medias45, reorder(modelo,tasa, mean))

par(cex.axis=0.5,las=2)
boxplot(data=medias45,tasa~modelo,col="pink")



```






## AUC

```{r}

# PRESENTACION TABLA MEDIAS
tablamedias2<-medias45 %>% group_by(modelo) %>% summarize(auc=mean(auc))
tablamedias2<-tablamedias2[order(-tablamedias2$auc),]

# ORDENACIÓN DEL FACTOR MODELO POR LAS MEDIAS EN AUC
# PARA EL GRAFICO

medias45$modelo <- with(medias45,
                       reorder(modelo,auc, mean))
par(cex.axis=0.7,las=2)
boxplot(data=medias45,auc~modelo,col="pink", main='AUC')

```


El mejor ensamblado es el de predi 19.2, es la union de xgbm,gbm y gbmmxm   y predi16,lo cual es la union de gradient boosting y Xboost 






```{r}
# Se pueden escoger listas pero el factor hay que pasarlo a character
# para que no salgan en el boxplot todos los niveles del factor

listadobis<-c("gbm","xgbm","predi16", "predi14", "predi17", "predi19","predi20","predi19.2") 

medias45$modelo<-as.character(medias45$modelo)

mediasver<-medias45[medias45$modelo %in% listadobis,]


mediasver$modelo <- with(mediasver,
                         reorder(modelo,auc, median))

par(cex.axis=0.9,las=2)
boxplot(data=mediasver,auc~modelo,col="pink",main='AUC')




# GRÁFICOS DE APOYO PARA OBSERVAR COMPORTAMIENTO DE LOS MODELOS

unipredi<-cbind(predi5,predi6,predi7,predi8,predi9,predi10,predi8.1)
# Esto es para eliminar columnas duplicadas
unipredi<- unipredi[, !duplicated(colnames(unipredi))]
# Añadir ensamblados

unipredi$predi14<-(unipredi$rf+unipredi$gbm)/2
unipredi$predi16<-(unipredi$gbm+unipredi$xgbm)/2
unipredi$predi17<-(unipredi$avnnet+unipredi$rf+unipredi$gbm)/3
unipredi$predi19<-(unipredi$rf+unipredi$gbm+unipredi$xgbm)/3
unipredi$predi20<-(unipredi$avnnet+unipredi$rf+unipredi$gbm+unipredi$xgbm)/4
unipredi$predi19.2<-(unipredi$xgbm+unipredi$gbm+unipredi$gbmmxm)/3



# Me quedo con la primera repetición de validación cruzada para los análisis
# A veces hay que poner Rep1 y otras veces Rep01, depende de cuantas repeticiones hemos pedido

unigraf<-unipredi[unipredi$Rep=="Rep01",]
unigraf
# Correlaciones entre predicciones de cada algoritmo individual
solos<-c("logi", "avnnet",
         "rf","gbm",  "xgbm","svmRadial","gbmmxm")
mat<-unigraf[,solos]
matrizcorr<-cor(mat)
matrizcorr


library(corrplot)
corrplot(matrizcorr, type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45,cl.lim=c(0.7,1),is.corr=FALSE)




library(ggplot2)

qplot(predi16,gbm,data=unigraf,colour=obs)+
  geom_hline(yintercept=0.5, color="black", size=1)+
  geom_vline(xintercept=0.5, color="black", size=1)

qplot(gbm,xgbm,data=unigraf,colour=obs)+
  geom_hline(yintercept=0.5, color="black", size=1)+
  geom_vline(xintercept=0.5, color="black", size=1)

qplot(gbm,gbmmxm,data=unigraf,colour=obs)+
  geom_hline(yintercept=0.5, color="black", size=1)+
  geom_vline(xintercept=0.5, color="black", size=1)

qplot(predi19.2,gbmmxm,data=unigraf,colour=obs)+
  geom_hline(yintercept=0.5, color="black", size=1)+
  geom_vline(xintercept=0.5, color="black", size=1)


qplot(predi19.2,gbm,data=unigraf,colour=obs)+
  geom_hline(yintercept=0.5, color="black", size=1)+
  geom_vline(xintercept=0.5, color="black", size=1)


```


## TEST

```{r}

# Cambio a Yes, No, todas las predicciones

# for (prediccion in listado) 
#   { unipredi[,prediccion]<-ifelse(unipredi[,prediccion]>0.5,"Yes","No") }

# Defino funcion tasafallos 

tasafallos<-function(x,y) { 
  confu<-confusionMatrix(x,y) 
tasa<-confu[[3]][1] 
return(tasa) } 


auc<-function(x,y) { 
  curvaroc<-roc(response=x,predictor=y) 
  auc<-curvaroc$auc 
  return(auc) 
  }

# Se obtiene el numero de repeticiones CV y se calculan las medias por repe en # el data frame medias0 



repeticiones<-nlevels(factor(unipredi$Rep))
unipredi$Rep<-as.factor(unipredi$Rep)
unipredi$Rep<-as.numeric(unipredi$Rep)





medias45t<-data.frame(c())
for (prediccion in listado)
{
  unipredi$proba<-unipredi[,prediccion]
  unipredi[,prediccion]<-ifelse(unipredi[,prediccion]>0.5,"Yes","No")
  for (repe in 1:repeticiones)
  {
    paso <- unipredi[(unipredi$Rep==repe),]
    pre<-factor(paso[,prediccion])
    archi<-paso[,c("proba","obs")]
    archi<-archi[order(archi$proba),]
    obs<-paso[,c("obs")]
    tasa=1-tasafallos(pre,obs)
    t<-as.data.frame(tasa)
    t$modelo<-prediccion
    auc<-suppressMessages(auc(archi$obs,archi$proba))
    t$auc<-auc
    medias45t<-rbind(medias45t,t)
  }
}


# medias45<-data.frame(c()) 
# for (prediccion in listado) 
#   { for (repe in 1:repeticiones) 
#     { 
#     paso <- unipredi[(unipredi$Rep==repe),] 
#     pre<-factor(paso[,prediccion]) 
#     obs<-paso[,c("obs")] 
#     tasa=1-tasafallos(pre,obs) 
#     t<-as.data.frame(tasa) 
#     t$modelo<-prediccion
#     auc<-suppressMessages(auc(archi$obs,archi$proba))
#     t$auc<-auc
# medias45<-rbind(medias45,t) } }




# Finalmente boxplot
par(cex.axis=0.5,las=2)
boxplot(data=medias45,tasa~modelo,col="pink",main="TASA FALLOS")



# PRESENTACION TABLA MEDIAS 

tablamedias<-medias45 %>% group_by(modelo) %>% summarize(tasa=mean(tasa))
tablamedias<-as.data.frame(tablamedias[order(tablamedias$tasa),])


# ORDENACIÓN DEL FACTOR MODELO POR LAS MEDIAS EN TASA # PARA EL GRAFICO
medias45$modelo <- with(medias45, reorder(modelo,tasa, mean))

par(cex.axis=0.5,las=2)
boxplot(data=medias45,tasa~modelo,col="pink")



```






#PUNTO CORTE 0.5    
```{r}

unigraf1<-unipredi[unipredi$Rep=="Rep01",]
unigraf1
unigraf1192 <- unigraf1|> select(obs,predi19.2)
unigraf1192

preditest192<-unigraf1192

preditest192
auc192<-roc(preditest192$obs,preditest192$predi19.2,levels=c("Yes","No"))

auc192




corte<-0.5


unigraf1192$predi19.2<-ifelse(unigraf1192$predi19.2>corte,"Yes","No")
unigraf1192$predi19.2<-as.factor(unigraf1192$predi19.2)
unigraf1192

confusionMatrix(reference=unigraf1192$obs,data=unigraf1192$predi19.2, positive="Yes")





# Confusion Matrix and Statistics
# 
#           Reference
# Prediction   No  Yes
#        No  1672  605
#        Yes  687 1655
#                                           
#                Accuracy : 0.7203          
#                  95% CI : (0.7071, 0.7332)
#     No Information Rate : 0.5107          
#     P-Value [Acc > NIR] : < 2e-16         
#                                           
#                   Kappa : 0.4407          
#                                           
#  Mcnemar's Test P-Value : 0.02423         
#                                           
#             Sensitivity : 0.7323          
#             Specificity : 0.7088          
#          Pos Pred Value : 0.7067          
#          Neg Pred Value : 0.7343          
#              Prevalence : 0.4893          
#          Detection Rate : 0.3583          
#    Detection Prevalence : 0.5070          
#       Balanced Accuracy : 0.7205
      

```
0.51 OK



#PUNTO CORTE 0.51
```{r}

unigraf2<-unipredi[unipredi$Rep=="Rep01",]
unigraf2
unigraf2192 <- unigraf2|> select(obs,predi19.2)
unigraf2192

preditest1922<-unigraf2192

preditest1922
auc1922<-roc(preditest1922$obs,preditest1922$predi19.2,levels=c("Yes","No"))

auc1922



corte<-0.51


unigraf2192$predi19.2<-ifelse(unigraf2192$predi19.2>corte,"Yes","No")
unigraf2192$predi19.2<-as.factor(unigraf2192$predi19.2)

unigraf2192

confusionMatrix(reference=unigraf2192$obs,data=unigraf2192$predi19.2, positive="Yes")


# Confusion Matrix and Statistics
# 
#           Reference
# Prediction   No  Yes
#        No  1691  620
#        Yes  668 1640
#                                         
#                Accuracy : 0.7212        
#                  95% CI : (0.708, 0.734)
#     No Information Rate : 0.5107        
#     P-Value [Acc > NIR] : <2e-16        
#                                         
#                   Kappa : 0.4423        
#                                         
#  Mcnemar's Test P-Value : 0.1903        
#                                         
#             Sensitivity : 0.7257        
#             Specificity : 0.7168        
#          Pos Pred Value : 0.7106        
#          Neg Pred Value : 0.7317        
#              Prevalence : 0.4893        
#          Detection Rate : 0.3551        
#    Detection Prevalence : 0.4997        
#       Balanced Accuracy : 0.7212        
#                                         
#        'Positive' Class : Yes   
      

```

## Variable prediccion de ensamblado

```{r}
preditotal = logi_predict$pred



preditotal$Yes = (logi_predict$pred$Yes+rf_predict$pred$Yes+xgbm_predict$pred$Yes+rednnet_predict$pred$Yes+SVM_poly_predict$pred$Yes) / 5

preditotal$No = (logi_predict$pred$No+rf_predict$pred$No+xgbm_predict$pred$No+rednnet_predict$pred$No+SVM_poly_predict$pred$No) / 5

umbral <- 0.5

preditotal$pred <- ifelse(preditotal$Yes >= umbral, "Yes", "No")

example <- confusionMatrix(data=factor(preditotal$pred), reference = factor(preditotal$obs), positive = "Yes")

# Imprimir la matriz de confusión
print(example)
```





##Contraste de hipotesis gbm y predi16
```{r}
listamodelos<-c("gbm","predi16")

datacontraste<-medias45[which(medias45$modelo%in%listamodelos),]

# Para Tasa de fallos

res <- t.test(datacontraste$tasa ~datacontraste$modelo)
res
# "gbm" es significativamente mayor que la tasa de aciertos del modelo "predi16".

# Para auc

res1 <- t.test(datacontraste$auc ~datacontraste$modelo)
res1
# Esto sugiere que la tasa de aciertos del modelo "predi16" es significativamente mayor que la tasa de aciertos del modelo "gbm".
```



##Contraste de hipotesis gbm y gbm
```{r}
listamodelos<-c("gbm","gbmmxm")

datacontraste<-medias45[which(medias45$modelo%in%listamodelos),]

# Para Tasa de fallos

resmxm <- t.test(datacontraste$tasa ~datacontraste$modelo)
resmxm
# "gbm" es significativamente mayor que la tasa de aciertos del modelo "predi16".

# Para auc

resmxm1 <- t.test(datacontraste$auc ~datacontraste$modelo)
resmxm1
# Esto sugiere que la tasa de aciertos del modelo "predi16" es significativamente mayor que la tasa de aciertos del modelo "gbm".
```



##Contraste de hipotesis pred16 y pred 19.2
```{r}
listamodelos<-c("predi16","predi19.2")

datacontraste<-medias45[which(medias45$modelo%in%listamodelos),]

# Para Tasa de fallos

respred <- t.test(datacontraste$tasa ~datacontraste$modelo)
respred
# La hipótesis nula establece que la verdadera diferencia en las medias entre los grupos "predi16" y "predi19.2" es igual a cero, mientras que la hipótesis alternativa sugiere que la verdadera diferencia en las medias es distinta de cero. Dado que el valor de p es menor que el nivel de significancia usual (0.05), se rechaza la hipótesis nula y se concluye que hay evidencia estadística para afirmar que existe una diferencia significativa entre las medias de los dos grupos.

# Para auc

respred1 <- t.test(datacontraste$auc ~datacontraste$modelo)
respred1
# cuando el valor de p es mayor que el nivel de significancia elegido (usualmente 0.05), no se puede rechazar la hipótesis nula y no hay suficiente evidencia estadística para afirmar que existe una diferencia significativa entre las medias de los dos grupos. En este caso, el valor de p es de 0.4364, lo que sugiere que no hay una diferencia estadísticamente significativa entre las medias de los grupos "predi16" y "predi19.2".


```